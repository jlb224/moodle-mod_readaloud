define(["jquery","core/log","mod_readaloud/cloudpoodllloader"],function(a,b,c){"use strict";return b.debug("Readaloud helper: initialising"),{status:"stopped",init:function(a,b,d,e){var f=this;c.init(a.recorderid,function(a){switch(console.log(a),a.type){case"recording":"started"===a.action?(f.startbuttonclick(),b(a)):"stopped"===a.action&&(f.stopbuttonclick(),d(a));break;case"awaitingprocessing":"posted"!=f.status&&e(a),f.status="posted"}})},stopbuttonclick:function(){this.status="stopped"},startbuttonclick:function(){this.status="started"},transformrecorder:function(){a("."+this.recordercontainer).attr("style","width: 1px; height: 1px;"),a("."+this.dummyrecorder).css("background-image","url("+M.cfg.wwwroot+"/mod/readaloud/pix/microphone.png)")},getpermissionmode:function(){this.awaitingpermission=!0,this.doshowsettings(),a("."+this.recinstructionscontainerleft).addClass("mod_readaloud_getpermissionmode"),a("."+this.recinstructionscontainerright).addClass("mod_readaloud_getpermissionmode")},clearpermissionmode:function(){this.awaitingpermission=!1,a("."+this.recinstructionscontainerleft).removeClass("mod_readaloud_getpermissionmode"),a("."+this.recinstructionscontainerright).removeClass("mod_readaloud_getpermissionmode")},recordbuttonclick:function(){var b=M.mod_readaloud.audiohelper;if(a(this).text(M.util.get_string("done","mod_readaloud")),M.mod_readaloud.audiohelper.awaitingpermission)return a(this).text(M.util.get_string("recordnameschool","mod_readaloud")),void M.mod_readaloud.audiohelper.clearpermissionmode();if("stopped"==b.fetchrecstatus()){if(!b.recorderallowed)return void M.mod_readaloud.audiohelper.getpermissionmode();b.dorecord()}else a(this).text(M.util.get_string("recordnameschool","mod_readaloud")),b.dostop(),b.gotsound?(a("."+b.recordbutton).hide(),a("."+b.startbutton).prop("disabled",!1)):alert(M.util.get_string("gotnosound","mod_readaloud"))},poodllcallback:function(a){switch("timerevent"!=a[1],a[1]){case"allowed":this.recorderallowed=a[2],this.recorderallowed&&(this.transformrecorder(),this.awaitingpermission&&this.dorecord(),this.clearpermissionmode());break;case"statuschanged":this.status=a[2],"haverecorded"==this.status&&this.passagerecorded&&(this.douploadlayout(),this.doexport());break;case"filesubmitted":this.dofinishedlayout();break;case"uploadstarted":break;case"showerror":this.doerrorlayout();break;case"actionerror":break;case"timeouterror":break;case"nosound":alert(M.util.get_string("gotnosound","mod_readaloud"));break;case"conversionerror":break;case"beginningconversion":break;case"conversioncomplete":break;case"timerevent":"0"!=a[2]&&this.dogotsound(lz.embed[a[0]].getCanvasAttribute("currentvolume"));break;case"volumeevent":a[2]>0;break;case"volume":}},makecanvas:function(a){var b=this.fetchcanvas(a);b||(b=document.createElement("canvas"));var c=document.getElementById(a);return b.id=a+"_canvas",b.className="mod_readaloud_voicecanvas",c.appendChild(b),b},fetchcanvas:function(a){return document.getElementById(a+"_canvas")},drawvoicechart:function(a){var b=this.fetchcanvas(a);if(b){var c=b.getContext("2d"),d=2*this.sounds.length;c.clearRect(0,0,b.width,b.height);for(var e=b.height/2,f=e/b.height,g=b.width/d,h=Array(),i=0;i<d;i+=2)h[i]=this.sounds[i]*f+e,h[i+1]=this.sounds[i]*f*-1+e;c.beginPath(),c.moveTo(b.width,e);for(var i=0;i<d;i++)c.lineTo(b.width-i*g,h[i]);c.stroke(),c.beginPath(),c.moveTo(0,e);for(var i=0;i<d;i++)c.lineTo(i*g,h[i]);c.stroke()}},dogotsound:function(a){this.sounds.length>10&&this.sounds.shift(),this.sounds.push(a),a>0&&(this.gotsound=!0),"stopped"!==this.fetchrecstatus()&&this.drawvoicechart(this.dummyrecorder)},dorecord:function(){a("."+this.dummyrecorder).removeClass(this.dummyrecorder+"_stopped"),a("."+this.dummyrecorder).addClass(this.dummyrecorder+"_recording"),this.makecanvas(this.dummyrecorder)}}});