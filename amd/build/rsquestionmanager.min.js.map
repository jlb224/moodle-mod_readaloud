{"version":3,"file":"rsquestionmanager.min.js","sources":["../src/rsquestionmanager.js"],"sourcesContent":["/* jshint ignore:start */\r\ndefine(['jquery', 'core/log','core/templates','mod_readaloud/definitions','mod_readaloud/modalformhelper',\r\n        'mod_readaloud/modaldeletehelper','mod_readaloud/moveitemhelper','mod_readaloud/modalpreviewhelper',\r\n        'mod_readaloud/duplicateitemhelper','mod_readaloud/datatables'],\r\n    function($,  log, templates, def, mfh, mdh, mih, mph,dplh, datatables) {\r\n\r\n    \"use strict\"; // jshint ;_;\r\n\r\n    log.debug('RSQuestion manager: initialising');\r\n\r\n    return {\r\n\r\n        cmid: null,\r\n        controls: null,\r\n        rowIds: [],\r\n\r\n\r\n        //pass in config\r\n        init: function(props){\r\n            var dd = this;\r\n            dd.contextid=props.contextid;\r\n            dd.tableid = props.tableid;\r\n            dd.modaleditform = props.modaleditform;\r\n            dd.cmid = props.cmid;\r\n            dd.wwwroot = props.wwwroot;\r\n\r\n            dd.register_events();\r\n            dd.process_html();\r\n            dd.collate_rowids();\r\n            dd.hide_useless_arrows();\r\n        },\r\n\r\n        process_html: function(){\r\n            this.controls = [];\r\n            this.controls.questionstable = datatables.getDataTable(this.tableid);\r\n            this.controls.questionscontainer = $('#' + def.itemscontainer);\r\n            this.controls.noquestionscontainer = $('#' + def.noitemscontainer);\r\n            this.controls.movearrows=$('#' + def.movearrow);\r\n        },\r\n\r\n        //we maintain an array of datatable rowids, indexed by itemorder\r\n        //we need this because moving, adding, deleting requires access to datatable rowid\r\n        collate_rowids: function(){\r\n            var dd = this;\r\n            dd.rowIds=[];\r\n\r\n            dd.controls.questionstable.rows().every( function ( rowindex, tableLoop, rowLoop ) {\r\n                var itemorder = dd.controls.questionstable.cell({row:rowindex, column:1}).data();\r\n                dd.rowIds[itemorder]=rowindex;\r\n            } );\r\n        },\r\n\r\n        //we wont to show move arrows, but hide arrows the final down and first up\r\n        hide_useless_arrows: function(){\r\n          //first lets show all the arrows\r\n          $('.mod_readaloud_item_move').attr('style','');\r\n\r\n          //if no rows just get out of here.\r\n          var rowcount=this.controls.questionstable.data().length;\r\n          if(!rowcount || rowcount<1){return;}\r\n\r\n          //hide bottom down arrow\r\n          var bottomrowindex=this.rowIds[rowcount];\r\n          var bottomtr = this.controls.questionstable.row(bottomrowindex).node();\r\n          $(bottomtr).find('.mod_readaloud_item_move[data-direction=\"down\"]').attr('style','visibility: hidden;');\r\n\r\n          //hide top up arrow\r\n          var toprowindex=this.rowIds[1];\r\n          var toptr = this.controls.questionstable.row(toprowindex).node();\r\n          $(toptr).find('.mod_readaloud_item_move[data-direction=\"up\"]').attr('style','visibility: hidden;');\r\n        },\r\n\r\n        // we need to renumber rows when we remove one, so we start from there and renumber the next ones\r\n        renumber_rows:function(fromorder) {\r\n\r\n            var thetable= this.controls.questionstable;\r\n            var rowcount = thetable.data().length;\r\n            for(var itemorder =fromorder; itemorder<rowcount;itemorder++){\r\n                var rowindex = this.rowIds[itemorder+1];\r\n                thetable.cell({row:rowindex, column:1}).data(itemorder);\r\n            }\r\n        },\r\n\r\n        move_row:function(itemid, direction) {\r\n            var thetable= this.controls.questionstable;\r\n            var therow = '#' + def.itemrow + '_' + itemid;\r\n            var currentrow = thetable.row(therow);\r\n            var currentindex = currentrow.index();\r\n            var currentorder = parseInt(thetable.cell({row:currentindex, column:1}).data());\r\n\r\n\r\n            var targetorder;\r\n            if(direction==\"up\"){\r\n                targetorder=currentorder-1;\r\n            } else if(direction==\"down\"){\r\n                targetorder=currentorder+1;\r\n            }\r\n\r\n            //should never arrive here pitching for out of range. But just in case\r\n            if(targetorder<1){return;}\r\n            var rowcount = thetable.data().length;\r\n            if(targetorder>rowcount){return;}\r\n\r\n            var targetindex = this.rowIds[targetorder];\r\n            var from = thetable.cell({row:currentindex, column:1}).data();\r\n            var to = thetable.cell({row:targetindex, column:1}).data();\r\n            thetable.cell({row:currentindex, column:1}).data(to);\r\n            thetable.cell({row:targetindex, column:1}).data(from);\r\n            thetable.draw(false);\r\n            this.collate_rowids();\r\n            \r\n        },\r\n        register_events: function() {\r\n          \r\n            var dd = this;\r\n        \r\n\r\n            var after_questionmove= function(itemid, direction) {\r\n                dd.move_row(itemid,direction);\r\n                dd.hide_useless_arrows();\r\n            };\r\n\r\n            var after_questionedit= function(item, itemid) {\r\n                var therow = '#' + def.itemrow + '_' + itemid;\r\n                dd.controls.questionstable.cell($(therow + ' .c1')).data(decodeURIComponent(item.name));\r\n            };\r\n            var after_questionadd= function(item, itemid) {\r\n                item.id = itemid;\r\n                item.name = decodeURIComponent(item.name);\r\n                item.index = dd.controls.questionstable.data().length+1;\r\n                item.up = {'key': 't/up','component': 'moodle','title': 'up'};\r\n                item.down = {'key': 't/down','component': 'moodle','title': 'down'};\r\n                templates.render('mod_readaloud/itemlistitem',item).then(\r\n                    function(html,js){\r\n                        //add row move to the last page so we can see the new row if its off page\r\n                        dd.controls.questionstable.row.add($(html)[0]).page('last').draw(false);\r\n                        dd.collate_rowids();\r\n                        dd.hide_useless_arrows();\r\n                    }\r\n                );\r\n                dd.controls.noquestionscontainer.hide();\r\n                dd.controls.questionscontainer.show();\r\n            };\r\n            var after_questionduplicate= function($resp) {\r\n\r\n                var ret = JSON.parse($resp);\r\n                var item={};\r\n                item.id = ret.newitemid;\r\n                item.name = decodeURIComponent(ret.newitemname);\r\n                item.type = ret.type;\r\n                item.typelabel = decodeURIComponent(ret.typelabel);\r\n                item.index = dd.controls.questionstable.data().length+1;\r\n                item.up = {'key': 't/up','component': 'moodle','title': 'up'};\r\n                item.down = {'key': 't/down','component': 'moodle','title': 'down'};\r\n                templates.render('mod_readaloud/itemlistitem',item).then(\r\n                    function(html,js){\r\n                        //add row move to the last page so we can see the new row if its off page\r\n                        dd.controls.questionstable.row.add($(html)[0]).page('last').draw(false);\r\n                        dd.collate_rowids();\r\n                        dd.hide_useless_arrows();\r\n                    }\r\n                );\r\n                dd.controls.noquestionscontainer.hide();\r\n                dd.controls.questionscontainer.show();\r\n            };\r\n            var after_questiondelete= function(itemid) {\r\n                log.debug('after question delete');\r\n                var therow=dd.controls.questionstable.row('#' + def.itemrow + '_' + itemid);\r\n                var itemorder=parseInt(therow.data()[0]);\r\n                dd.renumber_rows(itemorder);\r\n                therow.remove().draw(false);\r\n                dd.collate_rowids();\r\n                dd.hide_useless_arrows();\r\n                var itemcount = dd.controls.questionstable.rows().count();\r\n                if(!itemcount){\r\n                    dd.controls.noquestionscontainer.show();\r\n                    dd.controls.questionscontainer.hide();\r\n                }\r\n            };\r\n            var after_questionpreview= function(itemid) {\r\n                log.debug('after preview');\r\n                //we want to remove the question from DOM ... its still there and on subsequent shows, id will match on 2 elements and question will fail to unhide\r\n                $('#mod_readaloud_quiz_cont').remove();\r\n            };\r\n\r\n            //register ajax modal handler\r\n            var editcallback=function(item, itemid){console.log(item);};\r\n            var deletecallback=function(itemid){console.log(itemid);};\r\n            var addcallback=function(itemid){console.log(itemid);};\r\n            if(dd.modaleditform) {\r\n                mfh.init('.' + def.component + '_addlink', dd.contextid, after_questionadd);\r\n                //edit form helper\r\n                mfh.init('.' + def.itemrow + '_editlink', dd.contextid, after_questionedit);\r\n            }else{\r\n                $('.mod_readaloud_qpanel').on('click','.' + def.itemrow + '_editlink',function(){\r\n                    var editurl = dd.wwwroot + '/mod/readaloud/rsquestion/managersquestions.php?id=' + dd.cmid + '&itemid='+ $(this).data('id');\r\n                    log.debug('editurl ' + editurl);\r\n                    window.location.href=editurl;\r\n                });\r\n            }\r\n            //delete helper\r\n            mdh.init('.' + def.itemrow + '_deletelink', dd.contextid, 'deleteitem',after_questiondelete);\r\n            //move helper\r\n            mih.init('.' + def.movearrow , dd.contextid, after_questionmove);\r\n            //preview helper\r\n            mph.init('.' + def.itemrow + '_previewlink', dd.contextid, after_questionpreview);\r\n            //duplicate item helper\r\n            dplh.init('.' + def.itemrow + '_duplicatelink', dd.contextid, after_questionduplicate);\r\n        }\r\n\r\n    };//end of returned object\r\n});//total end\r\n"],"names":["define","$","log","templates","def","mfh","mdh","mih","mph","dplh","datatables","debug","cmid","controls","rowIds","init","props","dd","this","contextid","tableid","modaleditform","wwwroot","register_events","process_html","collate_rowids","hide_useless_arrows","questionstable","getDataTable","questionscontainer","itemscontainer","noquestionscontainer","noitemscontainer","movearrows","movearrow","rows","every","rowindex","tableLoop","rowLoop","itemorder","cell","row","column","data","attr","rowcount","length","bottomrowindex","bottomtr","node","find","toprowindex","toptr","renumber_rows","fromorder","thetable","move_row","itemid","direction","targetorder","therow","itemrow","currentindex","index","currentorder","parseInt","targetindex","from","to","draw","component","item","id","name","decodeURIComponent","up","down","render","then","html","js","add","page","hide","show","on","editurl","window","location","href","remove","count","$resp","ret","JSON","parse","newitemid","newitemname","type","typelabel"],"mappings":"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"}