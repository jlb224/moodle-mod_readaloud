{"version":3,"file":"shortanswer.min.js","sources":["../src/shortanswer.js"],"sourcesContent":["define(['jquery',\r\n      'core/log',\r\n      'mod_readaloud/definitions',\r\n      'mod_readaloud/pollyhelper',\r\n      'mod_readaloud/cloudpoodllloader',\r\n      'mod_readaloud/ttrecorder',\r\n      'mod_readaloud/animatecss'],\r\n    function($, log, def, polly,cloudpoodll, ttrecorder, anim) {\r\n  \"use strict\"; // jshint ;_;\r\n\r\n  /*\r\n  This file is to manage the quiz stage\r\n   */\r\n\r\n  log.debug('Readaloud ShortAnswer: initialising');\r\n\r\n  return {\r\n\r\n    //a handle on the tt recorder\r\n    ttrec: null,\r\n\r\n    passmark: 90,//lower this if it often doesnt match (was 85)\r\n\r\n    //for making multiple instances\r\n      clone: function () {\r\n          return $.extend(true, {}, this);\r\n     },\r\n\r\n    init: function(index, itemdata, quizhelper) {\r\n\r\n      //anim\r\n      var animopts = {};\r\n      animopts.useanimatecss=quizhelper.useanimatecss;\r\n      anim.init(animopts);\r\n\r\n      this.register_events(index, itemdata, quizhelper);\r\n      this.init_components(index, itemdata, quizhelper);\r\n    },\r\n    next_question: function(percent) {\r\n      var self = this;\r\n      var stepdata = {};\r\n      stepdata.index = self.index;\r\n      stepdata.hasgrade = true;\r\n      stepdata.totalitems = 1;\r\n      stepdata.correctitems = percent>0?1:0;\r\n      stepdata.grade = percent;\r\n      self.quizhelper.do_next(stepdata);\r\n    },\r\n\r\n    /* NOT NEEDED */\r\n    prepare_audio: function(itemdata) {\r\n      // debugger;\r\n      $.each(itemdata.sentences, function(index, sentence) {\r\n        polly.fetch_polly_url(sentence.sentence, itemdata.voiceoption, itemdata.usevoice).then(function(audiourl) {\r\n          $(\"#\" + itemdata.uniqueid + \"_option\" + (index+1)).attr(\"data-src\", audiourl);\r\n        });\r\n      });\r\n    },\r\n    \r\n    register_events: function(index, itemdata, quizhelper) {\r\n      \r\n      var self = this;\r\n      self.index = index;\r\n      self.quizhelper = quizhelper;\r\n      \r\n      $(\"#\" + itemdata.uniqueid + \"_container .readaloud_nextbutton\").on('click', function(e) {\r\n        self.next_question(0);\r\n      });\r\n      \r\n      $(\"#\" + itemdata.uniqueid + \"_container .\" + itemdata.uniqueid + \"_option\").on('click', function(e) {\r\n        \r\n        $(\".\" + itemdata.uniqueid + \"_option\").prop(\"disabled\", true);\r\n        $(\".\" + itemdata.uniqueid + \"_fb\").html(\"<i style='color:red;' class='fa fa-times'></i>\");\r\n        $(\".\" + itemdata.uniqueid + \"_option\" + itemdata.correctanswer + \"_fb\").html(\"<i style='color:green;' class='fa fa-check'></i>\");\r\n        \r\n        var checked = $('input[name='+itemdata.uniqueid+'_options]:checked').data('index');\r\n        var percent = checked == itemdata.correctanswer ? 100 : 0;\r\n        \r\n        $(\".readaloud_nextbutton\").prop(\"disabled\", true);\r\n        setTimeout(function() {\r\n          $(\".readaloud_nextbutton\").prop(\"disabled\", false);\r\n          self.next_question(percent);\r\n        }, 2000);\r\n        \r\n      });\r\n      \r\n    },\r\n\r\n    init_components: function(index, itemdata, quizhelper) {\r\n      var app= this;\r\n      var sentences = itemdata.sentences;//sentence & phonetic\r\n\r\n      log.debug('initcomponents_shortanswer');\r\n      log.debug(sentences);\r\n\r\n      //clean the text of any junk\r\n      for(var i=0;i<sentences.length;i++){\r\n          sentences[i].originalsentence= sentences[i].sentence;\r\n          sentences[i].sentence=quizhelper.cleanText(sentences[i].sentence);\r\n      }\r\n\r\n      var theCallback = async function(message) {\r\n\r\n        switch (message.type) {\r\n          case 'recording':\r\n\r\n            break;\r\n\r\n          case 'speech':\r\n            log.debug(\"speech at shortanswer\");\r\n            var speechtext = message.capturedspeech;\r\n            var cleanspeechtext = quizhelper.cleanText(speechtext);\r\n            var spoken = cleanspeechtext;\r\n\r\n            log.debug('speechtext:',speechtext);\r\n            log.debug('cleanspeechtext:',spoken);\r\n            var matched=false;\r\n            var percent=0;\r\n\r\n            //Similarity check by direct-match/acceptable-mistranscriptio\r\n            for(var x=0;x<sentences.length;x++){\r\n              //if this is the correct answer index, just move on\r\n              if(sentences[x].sentence===''){continue;}\r\n              var similar = quizhelper.similarity(spoken, sentences[x].sentence);\r\n              log.debug('JS similarity: ' + spoken + ':' + sentences[x].sentence + ':' + similar);\r\n              if (similar >= app.passmark ||\r\n                  app.spokenIsCorrect(quizhelper, cleanspeechtext, sentences[x].sentence)) {\r\n                  percent = app.process_accepted_response(itemdata, x);\r\n                  matched=true;\r\n                  break;\r\n              }//end of if similarity\r\n            }//end of for x\r\n\r\n            \r\n\r\n            //we do not do a passage match check , but this is how we would ..\r\n              if(!matched ) {\r\n                for (x = 0; x < sentences.length; x++) {\r\n                  var ajaxresult = await quizhelper.comparePassageToTranscript(sentences[x].sentence, spoken, sentences[x].phonetic, itemdata.language);\r\n                  var result = JSON.parse(ajaxresult);\r\n                  var haserror=false;\r\n                  for (var i=0;i<result.length;i++){\r\n                    if(result[i].matched===false){haserror=true;break;}\r\n                  }\r\n                  if(!haserror){\r\n                    percent = app.process_accepted_response(itemdata, x);\r\n                    matched=true;\r\n                    break;\r\n                  }\r\n                }\r\n              }\r\n\r\n              //if we got a match then process it\r\n            if(matched){\r\n              //proceed to next question\r\n              $(\".readaloud_nextbutton\").prop(\"disabled\", true);\r\n              setTimeout(function () {\r\n                $(\".readaloud_nextbutton\").prop(\"disabled\", false);\r\n                app.next_question(percent);\r\n              }, 2000);\r\n              return;\r\n            }else{\r\n              //shake the screen\r\n              var theanswer = $(\"#\" + itemdata.uniqueid + \"_correctanswer\");\r\n              anim.do_animate(theanswer,'rubberBand animate__faster').then(\r\n                  function() {}\r\n              );\r\n              //$(\"#\" + itemdata.uniqueid + \"_correctanswer\").effect(\"shake\");\r\n            }\r\n        } //end of switch message type\r\n      }; //end of callback declaration\r\n\r\n      //init TT recorder\r\n      var opts = {};\r\n      opts.uniqueid = itemdata.uniqueid;\r\n      log.debug('sa uniqueid:' + itemdata.uniqueid);\r\n      opts.callback = theCallback;\r\n      opts.stt_guided=quizhelper.is_stt_guided();\r\n      app.ttrec = ttrecorder.clone();\r\n      app.ttrec.init(opts);\r\n\r\n      //set the prompt for TT Rec\r\n      var allsentences=\"\";\r\n      for(var i=0;i<sentences.length;i++){\r\n        allsentences += sentences[i].sentence + ' ';\r\n        sentences[i].originalsentence= sentences[i].sentence;\r\n        sentences[i].sentence=quizhelper.cleanText(sentences[i].sentence);\r\n      }\r\n      app.ttrec.currentPrompt=allsentences;\r\n\r\n\r\n    } ,//end of init components\r\n\r\n    spokenIsCorrect: function(quizhelper, phraseheard, currentphrase) {\r\n      //lets lower case everything\r\n      phraseheard = quizhelper.cleanText(phraseheard);\r\n      currentphrase = quizhelper.cleanText(currentphrase);\r\n      if (phraseheard === currentphrase) {\r\n        return true;\r\n      }\r\n      return false;\r\n    },\r\n\r\n    process_accepted_response: function(itemdata, sentenceindex){\r\n      var percent = sentenceindex >= 0 ? 100 : 0;\r\n      //TO DO .. disable TT recorder here\r\n      //disable TT recorder\r\n\r\n      if(percent > 0) {\r\n        //turn dots into text (if they were dots)\r\n        if (parseInt(itemdata.show_text) === 0) {\r\n          for (var i = 0; i < itemdata.sentences.length; i++) {\r\n            var theline = $(\"#\" + itemdata.uniqueid + \"_option\" + (i + 1));\r\n            $(\"#\" + itemdata.uniqueid + \"_option\" + (i + 1) + ' .readaloud_sentence').text(itemdata.sentences[i].sentence);\r\n          }\r\n        }\r\n\r\n        //hightlight successgit cm\r\n        var  answerdisplay =  $(\"#\" + itemdata.uniqueid + \"_correctanswer\");\r\n        answerdisplay.text(itemdata.sentences[sentenceindex].originalsentence);\r\n        answerdisplay.addClass(\"readaloud_success\");\r\n      }\r\n\r\n      return percent;\r\n\r\n    },\r\n\r\n  };\r\n});"],"names":["define","$","log","def","polly","cloudpoodll","ttrecorder","anim","debug","ttrec","passmark","clone","extend","this","init","index","itemdata","quizhelper","animopts","useanimatecss","register_events","init_components","next_question","percent","stepdata","hasgrade","totalitems","correctitems","grade","do_next","prepare_audio","each","sentences","sentence","fetch_polly_url","voiceoption","usevoice","then","audiourl","uniqueid","attr","self","on","e","prop","html","correctanswer","data","setTimeout","app","i","length","originalsentence","cleanText","opts","callback","async","message","type","speechtext","capturedspeech","cleanspeechtext","spoken","matched","x","similar","similarity","spokenIsCorrect","process_accepted_response","ajaxresult","comparePassageToTranscript","phonetic","language","result","JSON","parse","haserror","theanswer","do_animate","stt_guided","is_stt_guided","allsentences","currentPrompt","phraseheard","currentphrase","sentenceindex","parseInt","show_text","text","answerdisplay","addClass"],"mappings":"AAAAA,mCAAO,CAAC,SACF,WACA,4BACA,4BACA,kCACA,2BACA,6BACF,SAASC,EAAGC,IAAKC,IAAKC,MAAMC,YAAaC,WAAYC,aAOvDL,IAAIM,MAAM,uCAEH,CAGLC,MAAO,KAEPC,SAAU,GAGRC,MAAO,kBACIV,EAAEW,QAAO,EAAM,GAAIC,OAGhCC,KAAM,SAASC,MAAOC,SAAUC,gBAG1BC,SAAW,GACfA,SAASC,cAAcF,WAAWE,cAClCZ,KAAKO,KAAKI,eAELE,gBAAgBL,MAAOC,SAAUC,iBACjCI,gBAAgBN,MAAOC,SAAUC,aAExCK,cAAe,SAASC,aAElBC,SAAW,GACfA,SAAST,MAFEF,KAEWE,MACtBS,SAASC,UAAW,EACpBD,SAASE,WAAa,EACtBF,SAASG,aAAeJ,QAAQ,EAAE,EAAE,EACpCC,SAASI,MAAQL,QANNV,KAONI,WAAWY,QAAQL,WAI1BM,cAAe,SAASd,UAEtBf,EAAE8B,KAAKf,SAASgB,WAAW,SAASjB,MAAOkB,UACzC7B,MAAM8B,gBAAgBD,SAASA,SAAUjB,SAASmB,YAAanB,SAASoB,UAAUC,MAAK,SAASC,UAC9FrC,EAAE,IAAMe,SAASuB,SAAW,WAAaxB,MAAM,IAAIyB,KAAK,WAAYF,iBAK1ElB,gBAAiB,SAASL,MAAOC,SAAUC,gBAErCwB,KAAO5B,KACX4B,KAAK1B,MAAQA,MACb0B,KAAKxB,WAAaA,WAElBhB,EAAE,IAAMe,SAASuB,SAAW,oCAAoCG,GAAG,SAAS,SAASC,GACnFF,KAAKnB,cAAc,MAGrBrB,EAAE,IAAMe,SAASuB,SAAW,eAAiBvB,SAASuB,SAAW,WAAWG,GAAG,SAAS,SAASC,GAE/F1C,EAAE,IAAMe,SAASuB,SAAW,WAAWK,KAAK,YAAY,GACxD3C,EAAE,IAAMe,SAASuB,SAAW,OAAOM,KAAK,kDACxC5C,EAAE,IAAMe,SAASuB,SAAW,UAAYvB,SAAS8B,cAAgB,OAAOD,KAAK,wDAGzEtB,QADUtB,EAAE,cAAce,SAASuB,SAAS,qBAAqBQ,KAAK,UACjD/B,SAAS8B,cAAgB,IAAM,EAExD7C,EAAE,yBAAyB2C,KAAK,YAAY,GAC5CI,YAAW,WACT/C,EAAE,yBAAyB2C,KAAK,YAAY,GAC5CH,KAAKnB,cAAcC,WAClB,SAMPF,gBAAiB,SAASN,MAAOC,SAAUC,gBACrCgC,IAAKpC,KACLmB,UAAYhB,SAASgB,UAEzB9B,IAAIM,MAAM,8BACVN,IAAIM,MAAMwB,eAGN,IAAIkB,EAAE,EAAEA,EAAElB,UAAUmB,OAAOD,IAC3BlB,UAAUkB,GAAGE,iBAAkBpB,UAAUkB,GAAGjB,SAC5CD,UAAUkB,GAAGjB,SAAShB,WAAWoC,UAAUrB,UAAUkB,GAAGjB,cA2ExDqB,KAAO,GACXA,KAAKf,SAAWvB,SAASuB,SACzBrC,IAAIM,MAAM,eAAiBQ,SAASuB,UACpCe,KAAKC,SA3EaC,eAAeC,gBAEvBA,QAAQC,UACT,sBAIA,SACHxD,IAAIM,MAAM,6BACNmD,WAAaF,QAAQG,eACrBC,gBAAkB5C,WAAWoC,UAAUM,YACvCG,OAASD,gBAEb3D,IAAIM,MAAM,cAAcmD,YACxBzD,IAAIM,MAAM,mBAAmBsD,gBACzBC,SAAQ,EACRxC,QAAQ,EAGJyC,EAAE,EAAEA,EAAEhC,UAAUmB,OAAOa,OAEF,KAAxBhC,UAAUgC,GAAG/B,cACZgC,QAAUhD,WAAWiD,WAAWJ,OAAQ9B,UAAUgC,GAAG/B,aACzD/B,IAAIM,MAAM,kBAAoBsD,OAAS,IAAM9B,UAAUgC,GAAG/B,SAAW,IAAMgC,SACvEA,SAAWhB,IAAIvC,UACfuC,IAAIkB,gBAAgBlD,WAAY4C,gBAAiB7B,UAAUgC,GAAG/B,UAAW,CACzEV,QAAU0B,IAAImB,0BAA0BpD,SAAUgD,GAClDD,SAAQ,aAQRA,YACGC,EAAI,EAAGA,EAAIhC,UAAUmB,OAAQa,IAAK,SACjCK,iBAAmBpD,WAAWqD,2BAA2BtC,UAAUgC,GAAG/B,SAAU6B,OAAQ9B,UAAUgC,GAAGO,SAAUvD,SAASwD,UACxHC,OAASC,KAAKC,MAAMN,YACpBO,UAAS,EACJ1B,EAAE,EAAEA,EAAEuB,OAAOtB,OAAOD,QACJ,IAApBuB,OAAOvB,GAAGa,QAAgB,CAACa,UAAS,YAErCA,SAAS,CACXrD,QAAU0B,IAAImB,0BAA0BpD,SAAUgD,GAClDD,SAAQ,YAObA,eAED9D,EAAE,yBAAyB2C,KAAK,YAAY,QAC5CI,YAAW,WACT/C,EAAE,yBAAyB2C,KAAK,YAAY,GAC5CK,IAAI3B,cAAcC,WACjB,SAICsD,UAAY5E,EAAE,IAAMe,SAASuB,SAAW,kBAC5ChC,KAAKuE,WAAWD,UAAU,8BAA8BxC,MACpD,iBAYZiB,KAAKyB,WAAW9D,WAAW+D,gBAC3B/B,IAAIxC,MAAQH,WAAWK,QACvBsC,IAAIxC,MAAMK,KAAKwC,UAGX2B,aAAa,OACT/B,EAAE,EAAEA,EAAElB,UAAUmB,OAAOD,IAC7B+B,cAAgBjD,UAAUkB,GAAGjB,SAAW,IACxCD,UAAUkB,GAAGE,iBAAkBpB,UAAUkB,GAAGjB,SAC5CD,UAAUkB,GAAGjB,SAAShB,WAAWoC,UAAUrB,UAAUkB,GAAGjB,UAE1DgB,IAAIxC,MAAMyE,cAAcD,cAK1Bd,gBAAiB,SAASlD,WAAYkE,YAAaC,sBAEjDD,YAAclE,WAAWoC,UAAU8B,iBACnCC,cAAgBnE,WAAWoC,UAAU+B,iBAOvChB,0BAA2B,SAASpD,SAAUqE,mBACxC9D,QAAU8D,eAAiB,EAAI,IAAM,KAItC9D,QAAU,EAAG,IAEuB,IAAjC+D,SAAStE,SAASuE,eACf,IAAIrC,EAAI,EAAGA,EAAIlC,SAASgB,UAAUmB,OAAQD,IAAK,CACpCjD,EAAE,IAAMe,SAASuB,SAAW,WAAaW,EAAI,IAC3DjD,EAAE,IAAMe,SAASuB,SAAW,WAAaW,EAAI,GAAK,wBAAwBsC,KAAKxE,SAASgB,UAAUkB,GAAGjB,cAKpGwD,cAAiBxF,EAAE,IAAMe,SAASuB,SAAW,kBAClDkD,cAAcD,KAAKxE,SAASgB,UAAUqD,eAAejC,kBACrDqC,cAAcC,SAAS,4BAGlBnE"}