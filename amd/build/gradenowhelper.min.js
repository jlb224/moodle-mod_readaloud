define(["jquery","core/log"],function(a,b){"use strict";return b.debug("Readaloud Gradenow helper: initialising"),{controls:{},cd:{audioplayerclass:"mod_readaloud_grading_player",wordplayerclass:"mod_readaloud_hidden_player",wordclass:"mod_readaloud_grading_passageword",spaceclass:"mod_readaloud_grading_passagespace",badwordclass:"mod_readaloud_grading_badword",endspaceclass:"mod_readaloud_grading_endspace",unreadwordclass:"mod_readaloud_grading_unreadword",wpmscoreid:"mod_readaloud_grading_wpm_score",accuracyscoreid:"mod_readaloud_grading_accuracy_score",sessionscoreid:"mod_readaloud_grading_session_score",errorscoreid:"mod_readaloud_grading_error_score",formelementwpmscore:"mod_readaloud_grading_form_wpm",formelementaccuracy:"mod_readaloud_grading_form_accuracy",formelementsessionscore:"mod_readaloud_grading_form_sessionscore",formelementendword:"mod_readaloud_grading_form_sessionendword",formelementtime:"mod_readaloud_grading_form_sessiontime",formelementerrors:"mod_readaloud_grading_form_sessionerrors"},options:{enabletts:!1,targetwpm:100,ttslanguage:"en",totalseconds:60,allowearlyexit:!1,timelimit:60,enforcemarker:!0,totalwordcount:0,wpm:0,accuracy:0,sessionscore:0,endwordnumber:0,errorwords:{},activityid:null,attemptid:null,sesskey:null,passagecontainer:"mod_readaloud_grading_passagecont"},init:function(c){var d="#"+c.id,e=a(d).get(0);if(!e)return void b.debug("Gradenow helper js: No config found on page. Giving up.");var f=JSON.parse(e.value);a(d).remove(),this.register_controls(),this.options.activityid=f.activityid,this.options.attemptid=f.attemptid,this.options.sesskey=f.sesskey,this.options.enabletts=f.enabletts,this.options.ttslanguage=f.ttslanguage,this.options.targetwpm=f.targetwpm,this.options.allowearlyexit=f.allowearlyexit,this.options.timelimit=f.timelimit,this.options.reviewmode=f.reviewmode,this.options.totalwordcount=a("."+this.cd.wordclass).length,f.sessiontime>0?(this.options.errorwords=JSON.parse(f.sessionerrors),this.options.totalseconds=f.sessiontime,this.options.endwordnumber=f.sessionendword,this.options.sessionscore=f.sessionscore,this.options.accuracy=f.accuracy,this.options.wpm=f.wpm,this.redrawgradestate()):this.options.endwordnumber=this.options.totalwordcount,this.controls.endwordmarker.addClass(this.cd.endspaceclass),this.register_events();var g=this,h=function(){g.options.allowearlyexit?g.options.totalseconds=Math.round(a("#"+g.cd.audioplayerclass).prop("duration")):g.options.totalseconds=g.options.timelimit,g.controls.formelementtime.val(g.options.totalseconds),g.processscores()},i=a("#"+this.cd.audioplayerclass);i.prop("readyState")<1&&this.options.allowearlyexit?i.on("loadedmetadata",h):h()},register_controls:function(){this.controls.wordplayer=a("#"+this.cd.wordplayerclass),this.controls.audioplayer=a("#"+this.cd.audioplayerclass),this.controls.eachword=a("."+this.cd.wordclass),this.controls.eachspace=a("."+this.cd.spaceclass),this.controls.endwordmarker=a("#"+this.cd.spaceclass+"_"+this.options.endwordnumber),this.controls.wpmscorebox=a("#"+this.cd.wpmscoreid),this.controls.accuracyscorebox=a("#"+this.cd.accuracyscoreid),this.controls.sessionscorebox=a("#"+this.cd.sessionscoreid),this.controls.errorscorebox=a("#"+this.cd.errorscoreid),this.controls.formelementwpmscore=a("#"+this.cd.formelementwpmscore),this.controls.formelementsessionscore=a("#"+this.cd.formelementsessionscore),this.controls.formelementaccuracy=a("#"+this.cd.formelementaccuracy),this.controls.formelementendword=a("#"+this.cd.formelementendword),this.controls.formelementerrors=a("#"+this.cd.formelementerrors),this.controls.formelementtime=a("#"+this.cd.formelementtime)},register_events:function(){var b=this;this.options.reviewmode?this.enabletts&&"none"!=this.options.ttslanguage&&this.controls.eachword.click(this.playword):(this.controls.eachword.click(function(){var c=a(this).attr("data-wordnumber"),d=a(this).text();b.options.enforcemarker&&Number(c)>Number(b.options.endwordnumber)||(c in b.options.errorwords?(delete b.options.errorwords[c],a(this).removeClass(b.cd.badwordclass)):(b.adderrorword(c,d),a(this).addClass(b.cd.badwordclass)),b.processscores())}),this.controls.eachspace.click(function(){var c=a(this).attr("data-wordnumber"),d=a("#"+b.cd.spaceclass+"_"+c);c==b.options.endwordnumber?(b.options.endwordnumber=b.options.totalwordcount,d.removeClass(b.cd.endspaceclass),a("#"+b.cd.spaceclass+"_"+b.options.totalwordcount).addClass(b.cd.endspaceclass)):(a("#"+b.cd.spaceclass+"_"+b.options.endwordnumber).removeClass(b.cd.endspaceclass),b.options.endwordnumber=c,d.addClass(b.cd.endspaceclass)),b.processunread(),b.processscores()}))},playword:function(){var b=this;b.controls.wordplayer.attr("src",M.cfg.wwwroot+"/mod/readaloud/tts.php?txt="+encodeURIComponent(a(this).text())+"&lang="+b.options.ttslanguage+"&n="+b.options.activityid),b.controls.wordplayer[0].pause(),b.controls.wordplayer[0].load(),b.controls.wordplayer[0].play()},redrawgradestate:function(){var b=this;this.processunread(),a.each(b.options.errorwords,function(c){a("#"+b.cd.wordclass+"_"+b.options.wordnumber).addClass(b.cd.badwordclass)})},adderrorword:function(a,b){this.options.errorwords[a]={word:b,wordnumber:a}},processword:function(){var b=this,c=a(this).attr("data-wordnumber"),d=a(this).text();b.options.enforcemarker&&Number(c)>Number(b.options.endwordnumber)||(c in b.options.errorwords?(delete b.options.errorwords[c],a(this).removeClass(b.cd.badwordclass)):(b.adderrorword(c,d),a(this).addClass(b.cd.badwordclass)),b.processscores())},processspace:function(){var b=this,c=a(this).attr("data-wordnumber"),d=a("#"+b.cd.spaceclass+"_"+c);c==b.options.endwordnumber?(b.options.endwordnumber=b.options.totalwordcount,d.removeClass(b.cd.endspaceclass),a("#"+b.cd.spaceclass+"_"+b.options.totalwordcount).addClass(b.cd.endspaceclass)):(a("#"+b.cd.spaceclass+"_"+b.options.endwordnumber).removeClass(b.cd.endspaceclass),b.options.endwordnumber=c,d.addClass(b.cd.endspaceclass)),b.processunread(),b.processscores()},processunread:function(){var b=this;b.controls.eachword.each(function(c){var d=a(this).attr("data-wordnumber");Number(d)>Number(b.options.endwordnumber)?(a(this).addClass(b.cd.unreadwordclass),b.options.enforcemarker&&d in b.options.errorwords&&(delete b.options.errorwords[d],a(this).removeClass(b.cd.badwordclass))):a(this).removeClass(b.cd.unreadwordclass)})},processscores:function(){var a=this,b=Object.keys(a.options.errorwords).length;a.controls.errorscorebox.text(b);var c=Math.round(60*(a.options.endwordnumber-b)/a.options.totalseconds);a.options.wpm=c,a.controls.wpmscorebox.text(c);var d=Math.round((a.options.endwordnumber-b)/a.options.endwordnumber*100);a.options.accuracy=d,a.controls.accuracyscorebox.text(d);var e=c;e>a.options.targetwpm&&(e=a.options.targetwpm);var f=Math.round(e/a.options.targetwpm*100);a.controls.sessionscorebox.text(f),a.controls.formelementwpmscore.val(c),a.controls.formelementsessionscore.val(f),a.controls.formelementaccuracy.val(d),a.controls.formelementendword.val(a.options.endwordnumber),a.controls.formelementerrors.val(JSON.stringify(a.options.errorwords))}}});