{"version":3,"file":"smallreporthelper.min.js","sources":["../src/smallreporthelper.js"],"sourcesContent":["define(['jquery', 'core/log','mod_readaloud/definitions','mod_readaloud/passagemarkuphelper','core/str','core/ajax','core/templates','core/notification'],\r\n    function ($, log, def, passagemarkuphelper, str, Ajax,templates, notification) {\r\n    \"use strict\"; // jshint ;_;\r\n    /*\r\n    This file does small report\r\n     */\r\n\r\n    log.debug('Click to hear: initialising');\r\n\r\n    return {\r\n        //controls\r\n        controls: {},\r\n        ready: false,\r\n        remotetranscribe: false,\r\n        showstats: true,\r\n        showgrades: true,\r\n        notingradebook: false,\r\n        attemptid: 0,\r\n        checking: '... checking ...',\r\n        secstillcheck: 'Checking again in: ',\r\n        notgradedyet: 'Your reading has not been evaluated yet.',\r\n        evaluated: 'Your reading has been evaluated.',\r\n        notaddedtogradebook: 'This was a shadow practice, and not added to gradebook.',\r\n\r\n        //class definitions\r\n        cd: {\r\n            wordclass: def.wordclass,\r\n            spaceclass: def.spaceclass,\r\n            badwordclass: def.badwordclass,\r\n            endspaceclass: def.endspaceclass,\r\n            unreadwordclass: def.unreadwordclass,\r\n            unreadspaceclass: def.unreadspaceclass,\r\n            aiunmatched: def.aiunmatched,\r\n            passagecontainer: def.passagecontainer,\r\n            fullreportcontainer: def.fullreportcontainer,\r\n        },\r\n\r\n        //init the module\r\n        init: function(props){\r\n\r\n            //pick up opts from html\r\n            var theid = props['configcontrolid'];\r\n            var configcontrol = $('#' + theid).get(0);\r\n            if (configcontrol) {\r\n                var opts = JSON.parse(configcontrol.value);\r\n                $(theid).remove();\r\n            } else {\r\n                //if there is no config we might as well give up\r\n                log.debug('Small Report: No config found on page. Giving up.');\r\n                return;\r\n            }\r\n\r\n            this.cmid=opts['cmid'];\r\n            this.attemptid=opts['attemptid'];\r\n            this.ready=opts['ready'];\r\n            this.remotetranscribe=opts['remotetranscribe'];\r\n            this.showstats =opts['showstats'];\r\n            this.showgrades =opts['showgrades'];\r\n            this.filename=opts['filename'];\r\n            this.notingradebook=opts['notingradebook'];\r\n\r\n            this.init_strings();\r\n            this.register_controls();\r\n            this.register_events();\r\n\r\n            //Init the full report passage\r\n            passagemarkuphelper.init($('.' + this.cd.fullreportcontainer));\r\n            if(opts['sessionmatches']){\r\n                passagemarkuphelper.markup_passage(opts['sessionmatches'],opts['sessionerrors'],opts['sessionendword']);\r\n\r\n            }\r\n\r\n            //if we are ready, we can start checking for results\r\n            if(!this.ready && this.attemptid){\r\n                this.start_check_for_results();\r\n            }\r\n\r\n        },\r\n\r\n        start_check_for_results: function(){\r\n            //hide the full report because we are not ready yet\r\n            this.controls.fullreportcontainer.hide();\r\n\r\n            //reset the small report to the default state\r\n            //how do we do that?\r\n\r\n            //if we are doing remote transcribe, we need to check for results\r\n            if(this.remotetranscribe) {\r\n                //check for ai results\r\n                this.check_for_results(this, 15);\r\n            }\r\n            //check for audio audio\r\n            this.check_for_audio(0);\r\n        },\r\n\r\n        init_strings: function(){\r\n          var that =this;\r\n          str.get_string('checking','mod_readaloud').done(function(s){that.checking=s;});\r\n          str.get_string('secs_till_check','mod_readaloud').done(function(s){that.secstillcheck=s;});\r\n          str.get_string('notgradedyet','mod_readaloud').done(function(s){that.notgradedyet=s;});\r\n          str.get_string('evaluatedmessage','mod_readaloud').done(function(s){that.evaluated=s;});\r\n          str.get_string('notaddedtogradebook','mod_readaloud').done(function(s){that.notaddedtogradebook=s;});\r\n        },\r\n\r\n        //load all the controls so we do not have to do it later\r\n        register_controls: function(){\r\n            this.controls.heading = $('.' + def.smallreportheading);\r\n            this.controls.fullreportcontainer = $('.' + def.fullreportcontainer);\r\n            this.controls.player = $('.' + def.smallreportplayer);\r\n            this.controls.dummyplayer = $('.' + def.smallreportdummyplayer);\r\n            this.controls.stars = $('.' + def.smallreportstars);\r\n            this.controls.cards = $('.' + def.smallreportcards);\r\n            this.controls.status = $('.' + def.smallreportstatus);\r\n        },\r\n\r\n        //attach the various event handlers we need\r\n        register_events: function() {\r\n            var that = this;\r\n        },//end of register events\r\n\r\n        check_for_audio: function(waitms){\r\n            //we commence a series of ping and retries until the recorded file is available\r\n            var that = this;\r\n            $.ajax({\r\n                url: that.filename,\r\n                method: 'HEAD',\r\n                cache: false,\r\n                error: function () {\r\n                    //We get here if its a 404 or 403. So settimout here and wait for file to arrive\r\n                    //we increment the timeout period each time to prevent bottlenecks\r\n                    log.debug('403 errors are normal here, till the audio file arrives back from conversion');\r\n                    setTimeout(function () {\r\n                        that.check_for_audio( waitms + 500);\r\n                    }, waitms);\r\n                },\r\n                success: function (data, textStatus, xhr) {\r\n                    switch (xhr.status) {\r\n                        case 200:\r\n\r\n                            //audioplayer\r\n                            var tdata=[];\r\n                            tdata.src=that.filename;\r\n                            tdata.UNIQID= that.generate_random_string(8);\r\n                            templates.render('mod_readaloud/audioplayer',tdata).then(\r\n                                function(html,js){\r\n                                    //that.controls.player.html(html);\r\n                                    templates.appendNodeContents('.' + def.smallreportplayer, html, js);\r\n                                    that.controls.dummyplayer.hide();\r\n                                }\r\n                            );\r\n                            break;\r\n                        default:\r\n                            setTimeout(function () {\r\n                                that.check_for_audio( waitms + 500);\r\n                            }, waitms);\r\n                    }\r\n\r\n                }\r\n            });\r\n        },\r\n\r\n       generate_random_string: function(length) {\r\n            var result = '';\r\n            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\r\n            var charactersLength = characters.length;\r\n\r\n            for (var i = 0; i < length; i++) {\r\n                result += characters.charAt(Math.floor(Math.random() * charactersLength));\r\n            }\r\n\r\n            return result;\r\n        },\r\n\r\n        check_for_results: function (that, seconds) {\r\n\r\n            //decrement 1 s. At 15 seconds do the check\r\n            seconds=seconds-1;\r\n            if(seconds>0){\r\n                setTimeout(that.check_for_results,1000,that,seconds);\r\n                that.controls.status.text(that.secstillcheck + seconds);\r\n                return;\r\n            }\r\n\r\n            //do the check\r\n            that.controls.status.text(that.checking);\r\n            Ajax.call([{\r\n                methodname: 'mod_readaloud_check_for_results',\r\n                args: {\r\n                    cmid: that.cmid\r\n                },\r\n                done: function (ajaxresult) {\r\n                    var payloadobject = JSON.parse(ajaxresult);\r\n                    if (payloadobject) {\r\n                        switch (payloadobject.ready) {\r\n                            case true:\r\n                                log.debug('result fetched');\r\n                                var heading = that.evaluated;\r\n                                if(that.notingradebook){\r\n                                    heading = heading + ' ' + that.notaddedtogradebook;\r\n                                }\r\n                                that.controls.heading.text(heading);\r\n                                var tdata=[];\r\n                                tdata.ready=payloadobject.ready;\r\n\r\n                                //stars\r\n\r\n                                //if we are not showing grades, everyone gets 5 stars\r\n                                if(!that.showgrades){payloadobject.rating=5;}\r\n\r\n                                var emptystar='fa-regular fa-star';\r\n                                var solidstar='fa-solid fa-star';\r\n                                var stars=[];\r\n                                for(var star=0;star<5;star++){\r\n                                    stars[star] = payloadobject.rating > star ? solidstar : emptystar;\r\n                                }\r\n                                tdata.stars=stars;\r\n                                templates.render('mod_readaloud/smallreportstars',tdata).then(\r\n                                    function(html,js){\r\n                                        that.controls.stars.html(html);\r\n                                    }\r\n                                );\r\n\r\n                                //stats\r\n                                //if we are not showing stats, we really should not be here\r\n                                if(!that.showstats){\r\n                                    that.controls.status.hide();\r\n                                    break;\r\n                                }\r\n\r\n                                tdata.wpm=payloadobject.wpm;\r\n                                tdata.acc=payloadobject.acc;\r\n                                tdata.totalwords=payloadobject.totalwords;\r\n\r\n                                templates.render('mod_readaloud/smallreportcards',tdata).then(\r\n                                    function(html,js){\r\n                                        that.controls.cards.html(html);\r\n                                    }\r\n                                );\r\n\r\n                                that.controls.status.hide();\r\n\r\n                                //re-markup the full report passage\r\n                                log.debug('clearing passage markup');\r\n                                passagemarkuphelper.clear_markup();\r\n                                if(that.showstats) {\r\n                                    log.debug('marking up passage');\r\n                                    passagemarkuphelper.markup_passage(payloadobject.sessionmatches,\r\n                                        payloadobject.sessionerrors, payloadobject.sessionendword);\r\n                                }\r\n\r\n                                //show the full report\r\n                                log.debug('showing full report');\r\n                                that.controls.fullreportcontainer.show();\r\n\r\n                                break;\r\n\r\n                            case false:\r\n                            default:\r\n                                log.debug('result not fetched');\r\n                                setTimeout(that.check_for_results,1000,that,10);\r\n                                that.controls.status.text(that.secstillcheck + seconds);\r\n                        }\r\n                    }\r\n                },\r\n                fail: notification.exception\r\n            }]);\r\n        },\r\n\r\n\r\n    };//end of return value\r\n});"],"names":["define","$","log","def","passagemarkuphelper","str","Ajax","templates","notification","debug","controls","ready","remotetranscribe","showstats","showgrades","notingradebook","attemptid","checking","secstillcheck","notgradedyet","evaluated","notaddedtogradebook","cd","wordclass","spaceclass","badwordclass","endspaceclass","unreadwordclass","unreadspaceclass","aiunmatched","passagecontainer","fullreportcontainer","init","props","theid","configcontrol","get","opts","JSON","parse","value","remove","cmid","filename","init_strings","register_controls","register_events","this","markup_passage","start_check_for_results","hide","check_for_results","check_for_audio","that","get_string","done","s","heading","smallreportheading","player","smallreportplayer","dummyplayer","smallreportdummyplayer","stars","smallreportstars","cards","smallreportcards","status","smallreportstatus","waitms","ajax","url","method","cache","error","setTimeout","success","data","textStatus","xhr","tdata","src","UNIQID","generate_random_string","render","then","html","js","appendNodeContents","length","result","characters","charactersLength","i","charAt","Math","floor","random","seconds","text","call","methodname","args","ajaxresult","payloadobject","rating","star","wpm","acc","totalwords","clear_markup","sessionmatches","sessionerrors","sessionendword","show","fail","exception"],"mappings":"AAAAA,yCAAO,CAAC,SAAU,WAAW,4BAA4B,oCAAoC,WAAW,YAAY,iBAAiB,sBACjI,SAAUC,EAAGC,IAAKC,IAAKC,oBAAqBC,IAAKC,KAAKC,UAAWC,qBAMjEN,IAAIO,MAAM,+BAEH,CAEHC,SAAU,GACVC,OAAO,EACPC,kBAAkB,EAClBC,WAAW,EACXC,YAAY,EACZC,gBAAgB,EAChBC,UAAW,EACXC,SAAU,mBACVC,cAAe,sBACfC,aAAc,2CACdC,UAAW,mCACXC,oBAAqB,0DAGrBC,GAAI,CACAC,UAAWpB,IAAIoB,UACfC,WAAYrB,IAAIqB,WAChBC,aAActB,IAAIsB,aAClBC,cAAevB,IAAIuB,cACnBC,gBAAiBxB,IAAIwB,gBACrBC,iBAAkBzB,IAAIyB,iBACtBC,YAAa1B,IAAI0B,YACjBC,iBAAkB3B,IAAI2B,iBACtBC,oBAAqB5B,IAAI4B,qBAI7BC,KAAM,SAASC,WAGPC,MAAQD,MAAK,gBACbE,cAAgBlC,EAAE,IAAMiC,OAAOE,IAAI,MACnCD,mBACIE,KAAOC,KAAKC,MAAMJ,cAAcK,OACpCvC,EAAEiC,OAAOO,cAORC,KAAKL,KAAI,UACTrB,UAAUqB,KAAI,eACd1B,MAAM0B,KAAI,WACVzB,iBAAiByB,KAAI,sBACrBxB,UAAWwB,KAAI,eACfvB,WAAYuB,KAAI,gBAChBM,SAASN,KAAI,cACbtB,eAAesB,KAAI,oBAEnBO,oBACAC,yBACAC,kBAGL1C,oBAAoB4B,KAAK/B,EAAE,IAAM8C,KAAKzB,GAAGS,sBACtCM,KAAI,gBACHjC,oBAAoB4C,eAAeX,KAAI,eAAmBA,KAAI,cAAkBA,KAAI,iBAKpFU,KAAKpC,OAASoC,KAAK/B,gBACdiC,+BA1BL/C,IAAIO,MAAM,sDA+BlBwC,wBAAyB,gBAEhBvC,SAASqB,oBAAoBmB,OAM/BH,KAAKnC,uBAECuC,kBAAkBJ,KAAM,SAG5BK,gBAAgB,IAGzBR,aAAc,eACRS,KAAMN,KACV1C,IAAIiD,WAAW,WAAW,iBAAiBC,MAAK,SAASC,GAAGH,KAAKpC,SAASuC,KAC1EnD,IAAIiD,WAAW,kBAAkB,iBAAiBC,MAAK,SAASC,GAAGH,KAAKnC,cAAcsC,KACtFnD,IAAIiD,WAAW,eAAe,iBAAiBC,MAAK,SAASC,GAAGH,KAAKlC,aAAaqC,KAClFnD,IAAIiD,WAAW,mBAAmB,iBAAiBC,MAAK,SAASC,GAAGH,KAAKjC,UAAUoC,KACnFnD,IAAIiD,WAAW,sBAAsB,iBAAiBC,MAAK,SAASC,GAAGH,KAAKhC,oBAAoBmC,MAIlGX,kBAAmB,gBACVnC,SAAS+C,QAAUxD,EAAE,IAAME,IAAIuD,yBAC/BhD,SAASqB,oBAAsB9B,EAAE,IAAME,IAAI4B,0BAC3CrB,SAASiD,OAAS1D,EAAE,IAAME,IAAIyD,wBAC9BlD,SAASmD,YAAc5D,EAAE,IAAME,IAAI2D,6BACnCpD,SAASqD,MAAQ9D,EAAE,IAAME,IAAI6D,uBAC7BtD,SAASuD,MAAQhE,EAAE,IAAME,IAAI+D,uBAC7BxD,SAASyD,OAASlE,EAAE,IAAME,IAAIiE,oBAIvCtB,gBAAiB,aAIjBM,gBAAiB,SAASiB,YAElBhB,KAAON,KACX9C,EAAEqE,KAAK,CACHC,IAAKlB,KAAKV,SACV6B,OAAQ,OACRC,OAAO,EACPC,MAAO,WAGHxE,IAAIO,MAAM,gFACVkE,YAAW,WACPtB,KAAKD,gBAAiBiB,OAAS,OAChCA,SAEPO,QAAS,SAAUC,KAAMC,WAAYC,QAExB,MADDA,IAAIZ,YAIAa,MAAM,GACVA,MAAMC,IAAI5B,KAAKV,SACfqC,MAAME,OAAQ7B,KAAK8B,uBAAuB,GAC1C5E,UAAU6E,OAAO,4BAA4BJ,OAAOK,MAChD,SAASC,KAAKC,IAEVhF,UAAUiF,mBAAmB,IAAMrF,IAAIyD,kBAAmB0B,KAAMC,IAChElC,KAAK3C,SAASmD,YAAYX,eAKlCyB,YAAW,WACPtB,KAAKD,gBAAiBiB,OAAS,OAChCA,YAOxBc,uBAAwB,SAASM,gBACxBC,OAAS,GACTC,WAAa,iEACbC,iBAAmBD,WAAWF,OAEzBI,EAAI,EAAGA,EAAIJ,OAAQI,IACxBH,QAAUC,WAAWG,OAAOC,KAAKC,MAAMD,KAAKE,SAAWL,0BAGpDF,QAGXvC,kBAAmB,SAAUE,KAAM6C,aAG/BA,SAAgB,GACL,SACPvB,WAAWtB,KAAKF,kBAAkB,IAAKE,KAAK6C,cAC5C7C,KAAK3C,SAASyD,OAAOgC,KAAK9C,KAAKnC,cAAgBgF,SAKnD7C,KAAK3C,SAASyD,OAAOgC,KAAK9C,KAAKpC,UAC/BX,KAAK8F,KAAK,CAAC,CACPC,WAAY,kCACZC,KAAM,CACF5D,KAAMW,KAAKX,MAEfa,KAAM,SAAUgD,gBACRC,cAAgBlE,KAAKC,MAAMgE,eAC3BC,qBACQA,cAAc7F,YACb,EACDT,IAAIO,MAAM,sBACNgD,QAAUJ,KAAKjC,UAChBiC,KAAKtC,iBACJ0C,QAAUA,QAAU,IAAMJ,KAAKhC,qBAEnCgC,KAAK3C,SAAS+C,QAAQ0C,KAAK1C,aACvBuB,MAAM,GACVA,MAAMrE,MAAM6F,cAAc7F,MAKtB0C,KAAKvC,aAAY0F,cAAcC,OAAO,WAItC1C,MAAM,GACF2C,KAAK,EAAEA,KAAK,EAAEA,OAClB3C,MAAM2C,MAAQF,cAAcC,OAASC,KAH3B,mBADA,wBAMd1B,MAAMjB,MAAMA,MACZxD,UAAU6E,OAAO,iCAAiCJ,OAAOK,MACrD,SAASC,KAAKC,IACVlC,KAAK3C,SAASqD,MAAMuB,KAAKA,UAM7BjC,KAAKxC,UAAU,CACfwC,KAAK3C,SAASyD,OAAOjB,aAIzB8B,MAAM2B,IAAIH,cAAcG,IACxB3B,MAAM4B,IAAIJ,cAAcI,IACxB5B,MAAM6B,WAAWL,cAAcK,WAE/BtG,UAAU6E,OAAO,iCAAiCJ,OAAOK,MACrD,SAASC,KAAKC,IACVlC,KAAK3C,SAASuD,MAAMqB,KAAKA,SAIjCjC,KAAK3C,SAASyD,OAAOjB,OAGrBhD,IAAIO,MAAM,2BACVL,oBAAoB0G,eACjBzD,KAAKxC,YACJX,IAAIO,MAAM,sBACVL,oBAAoB4C,eAAewD,cAAcO,eAC7CP,cAAcQ,cAAeR,cAAcS,iBAInD/G,IAAIO,MAAM,uBACV4C,KAAK3C,SAASqB,oBAAoBmF,qBAMlChH,IAAIO,MAAM,sBACVkE,WAAWtB,KAAKF,kBAAkB,IAAKE,KAAK,IAC5CA,KAAK3C,SAASyD,OAAOgC,KAAK9C,KAAKnC,cAAgBgF,WAI/DiB,KAAM3G,aAAa4G"}