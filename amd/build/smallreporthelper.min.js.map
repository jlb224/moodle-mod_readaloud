{"version":3,"file":"smallreporthelper.min.js","sources":["../src/smallreporthelper.js"],"sourcesContent":["define(['jquery', 'core/log','mod_readaloud/definitions','mod_readaloud/passagemarkuphelper','core/str','core/ajax','core/templates','core/notification'],\n    function ($, log, def, passagemarkuphelper, str, Ajax,templates, notification) {\n    \"use strict\"; // jshint ;_;\n    /*\n    This file does small report\n     */\n\n    log.debug('Click to hear: initialising');\n\n    return {\n        //controls\n        controls: {},\n        ready: false,\n        remotetranscribe: false,\n        showstats: true,\n        showgrades: true,\n        notingradebook: false,\n        attemptid: 0,\n        checking: '... checking ...',\n        secstillcheck: 'Checking again in: ',\n        notgradedyet: 'Your reading has not been evaluated yet.',\n        evaluated: 'Your reading has been evaluated.',\n        notaddedtogradebook: 'This was a shadow practice, and not added to gradebook.',\n\n        //class definitions\n        cd: {\n            wordclass: def.wordclass,\n            spaceclass: def.spaceclass,\n            badwordclass: def.badwordclass,\n            endspaceclass: def.endspaceclass,\n            unreadwordclass: def.unreadwordclass,\n            unreadspaceclass: def.unreadspaceclass,\n            aiunmatched: def.aiunmatched,\n            passagecontainer: def.passagecontainer,\n            fullreportcontainer: def.fullreportcontainer,\n        },\n\n        //init the module\n        init: function(props){\n\n            //pick up opts from html\n            var theid = props['configcontrolid'];\n            var configcontrol = $('#' + theid).get(0);\n            if (configcontrol) {\n                var opts = JSON.parse(configcontrol.value);\n                $(theid).remove();\n            } else {\n                //if there is no config we might as well give up\n                log.debug('Small Report: No config found on page. Giving up.');\n                return;\n            }\n\n            this.attemptid=opts['attemptid'];\n            this.ready=opts['ready'];\n            this.remotetranscribe=opts['remotetranscribe'];\n            this.showstats =opts['showstats'];\n            this.showgrades =opts['showgrades'];\n            this.filename=opts['filename'];\n            this.notingradebook=opts['notingradebook'];\n\n            this.init_strings();\n            this.register_controls();\n            this.register_events();\n\n            //Init the full report passage\n            passagemarkuphelper.init($('.' + this.cd.fullreportcontainer));\n            if(opts['sessionmatches']){\n                passagemarkuphelper.markup_passage(opts['sessionmatches'],opts['sessionerrors'],opts['sessionendword']);\n            }\n\n            if(!this.ready && this.attemptid){\n                if(this.remotetranscribe) {\n                    //check for ai results\n                    this.check_for_results(this, 15);\n                }\n                //check for audio audio\n                this.check_for_audio(0);\n            }\n\n        },\n\n        init_strings: function(){\n          var that =this;\n          str.get_string('checking','mod_readaloud').done(function(s){that.checking=s;});\n          str.get_string('secs_till_check','mod_readaloud').done(function(s){that.secstillcheck=s;});\n          str.get_string('notgradedyet','mod_readaloud').done(function(s){that.notgradedyet=s;});\n          str.get_string('evaluatedmessage','mod_readaloud').done(function(s){that.evaluated=s;});\n          str.get_string('notaddedtogradebook','mod_readaloud').done(function(s){that.notaddedtogradebook=s;});\n        },\n\n        //load all the controls so we do not have to do it later\n        register_controls: function(){\n            this.controls.heading = $('.' + def.smallreportheading);\n            this.controls.player = $('.' + def.smallreportplayer);\n            this.controls.dummyplayer = $('.' + def.smallreportdummyplayer);\n            this.controls.stars = $('.' + def.smallreportstars);\n            this.controls.cards = $('.' + def.smallreportcards);\n            this.controls.status = $('.' + def.smallreportstatus);\n        },\n\n        //attach the various event handlers we need\n        register_events: function() {\n            var that = this;\n        },//end of register events\n\n        check_for_audio: function(waitms){\n            //we commence a series of ping and retries until the recorded file is available\n            var that = this;\n            $.ajax({\n                url: that.filename,\n                method: 'HEAD',\n                cache: false,\n                error: function () {\n                    //We get here if its a 404 or 403. So settimout here and wait for file to arrive\n                    //we increment the timeout period each time to prevent bottlenecks\n                    log.debug('403 errors are normal here, till the audio file arrives back from conversion');\n                    setTimeout(function () {\n                        that.check_for_audio( waitms + 500);\n                    }, waitms);\n                },\n                success: function (data, textStatus, xhr) {\n                    switch (xhr.status) {\n                        case 200:\n\n                            //audioplayer\n                            var tdata=[];\n                            tdata.src=that.filename;\n                            tdata.UNIQID= that.generate_random_string(8);\n                            templates.render('mod_readaloud/audioplayer',tdata).then(\n                                function(html,js){\n                                    //that.controls.player.html(html);\n                                    templates.appendNodeContents('.' + def.smallreportplayer, html, js);\n                                    that.controls.dummyplayer.hide();\n                                }\n                            );\n                            break;\n                        default:\n                            setTimeout(function () {\n                                that.check_for_audio( waitms + 500);\n                            }, waitms);\n                    }\n\n                }\n            });\n        },\n\n       generate_random_string: function(length) {\n            var result = '';\n            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n            var charactersLength = characters.length;\n\n            for (var i = 0; i < length; i++) {\n                result += characters.charAt(Math.floor(Math.random() * charactersLength));\n            }\n\n            return result;\n        },\n\n        check_for_results: function (that, seconds) {\n\n            //decrement 1 s. At 15 seconds do the check\n            seconds=seconds-1;\n            if(seconds>0){\n                setTimeout(that.check_for_results,1000,that,seconds);\n                that.controls.status.text(that.secstillcheck + seconds);\n                return;\n            }\n\n            //do the check\n            that.controls.status.text(that.checking);\n            Ajax.call([{\n                methodname: 'mod_readaloud_check_for_results',\n                args: {\n                    attemptid: that.attemptid\n                },\n                done: function (ajaxresult) {\n                    var payloadobject = JSON.parse(ajaxresult);\n                    if (payloadobject) {\n                        switch (payloadobject.ready) {\n                            case true:\n                                log.debug('result fetched');\n                                var heading = that.evaluated;\n                                if(that.notingradebook){\n                                    heading = heading + ' ' + that.notaddedtogradebook;\n                                }\n                                that.controls.heading.text(heading);\n                                var tdata=[];\n                                tdata.ready=payloadobject.ready;\n\n                                //stars\n\n                                //if we are not showing grades, everyone gets 5 stars\n                                if(!that.showgrades){payloadobject.rating=5;}\n\n                                var emptystar='fa-regular fa-star';\n                                var solidstar='fa-solid fa-star';\n                                var stars=[];\n                                for(var star=0;star<5;star++){\n                                    stars[star] = payloadobject.rating > star ? solidstar : emptystar;\n                                }\n                                tdata.stars=stars;\n                                templates.render('mod_readaloud/smallreportstars',tdata).then(\n                                    function(html,js){\n                                        that.controls.stars.html(html);\n                                    }\n                                );\n\n                                //stats\n                                //if we are not showing stats, we really should not be here\n                                if(!that.showstats){\n                                    that.controls.status.hide();\n                                    break;\n                                }\n\n                                tdata.wpm=payloadobject.wpm;\n                                tdata.acc=payloadobject.acc;\n                                tdata.totalwords=payloadobject.totalwords;\n\n                                templates.render('mod_readaloud/smallreportcards',tdata).then(\n                                    function(html,js){\n                                        that.controls.cards.html(html);\n                                    }\n                                );\n\n                                that.controls.status.hide();\n\n                                //re-markup the full report passage\n                                passagemarkuphelper.clear_markup();\n                                if(that.showstats) {\n                                    passagemarkuphelper.markup_passage(opts['sessionmatches'], opts['sessionerrors'], opts['sessionendword']);\n                                }\n\n                                break;\n\n                            case false:\n                            default:\n                                log.debug('result not fetched');\n                                setTimeout(that.check_for_results,1000,that,10);\n                                that.controls.status.text(that.secstillcheck + seconds);\n                        }\n                    }\n                },\n                fail: notification.exception\n            }]);\n        },\n\n\n    };//end of return value\n});"],"names":["define","$","log","def","passagemarkuphelper","str","Ajax","templates","notification","debug","controls","ready","remotetranscribe","showstats","showgrades","notingradebook","attemptid","checking","secstillcheck","notgradedyet","evaluated","notaddedtogradebook","cd","wordclass","spaceclass","badwordclass","endspaceclass","unreadwordclass","unreadspaceclass","aiunmatched","passagecontainer","fullreportcontainer","init","props","theid","configcontrol","get","opts","JSON","parse","value","remove","filename","init_strings","register_controls","register_events","this","markup_passage","check_for_results","check_for_audio","that","get_string","done","s","heading","smallreportheading","player","smallreportplayer","dummyplayer","smallreportdummyplayer","stars","smallreportstars","cards","smallreportcards","status","smallreportstatus","waitms","ajax","url","method","cache","error","setTimeout","success","data","textStatus","xhr","tdata","src","UNIQID","generate_random_string","render","then","html","js","appendNodeContents","hide","length","result","characters","charactersLength","i","charAt","Math","floor","random","seconds","text","call","methodname","args","ajaxresult","payloadobject","rating","star","wpm","acc","totalwords","clear_markup","fail","exception"],"mappings":"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"}