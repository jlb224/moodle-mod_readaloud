define(["jquery","core/log","mod_readaloud/definitions","mod_readaloud/recorderhelper","mod_readaloud/modelaudiokaraoke"],function(a,b,c,d,e){"use strict";return b.debug("Model Audio helper: initialising"),{controls:{},currentmode:"modeling",breaks:[],goturl:!1,cd:{audioplayerclass:c.modelaudioplayerclass,wordclass:c.wordclass,spaceclass:c.spaceclass,endspaceclass:c.endspaceclass,passagecontainer:c.passagecontainer,breaksfield:c.modelaudiobreaksfield,urlfield:c.modelaudiourlfield,modeltranscriptbutton:c.modeltranscriptbutton,modeltranscript:c.modeltranscript},init:function(a){a.breaks&&(this.breaks=JSON.parse(a.breaks)),this.register_controls(),this.register_events(),this.markup_passage(),this.init_recorder(a),this.init_karaoke();var b=this.controls.audioplayer.attr("src");null!=b&&this.check_modelaudio_transcript_ready(b,5e3)},init_karaoke:function(){var a={audioplayerclass:this.cd.audioplayerclass};e.init(a),e.set_breaks(this.breaks)},init_recorder:function(a){var b=this,c=function(a){b.goturl=!1},e=function(a){},f=function(a){b.goturl||(b.controls.urlfield.val(a.mediaurl),b.goturl=!0)};d.init(a,c,e,f)},register_controls:function(){this.controls.audioplayer=a("#"+this.cd.audioplayerclass),this.controls.eachword=a("."+this.cd.wordclass),this.controls.eachspace=a("."+this.cd.spaceclass),this.controls.passagecontainer=a("."+this.cd.passagecontainer),this.controls.breaksfield=a("#"+this.cd.breaksfield),this.controls.urlfield=a("#"+this.cd.urlfield),this.controls.modeltranscript=a("#"+this.cd.modeltranscript),this.controls.modeltranscriptbutton=a("#"+this.cd.modeltranscriptbutton)},register_events:function(){var b=this,c=function(){if("modeling"===b.currentmode){var c=parseInt(a(this).attr("data-wordnumber")),d=a("#"+b.cd.spaceclass+"_"+c);if(d.hasClass(b.cd.endspaceclass))b.remove_break(c),d.removeClass(b.cd.endspaceclass);else{d.addClass(b.cd.endspaceclass);var e=b.controls.audioplayer[0],f=e.currentTime;b.register_break(c,f)}}};this.controls.eachword.click(c),this.controls.eachspace.click(c),this.controls.modeltranscriptbutton.click(function(){a(this).hide(),b.controls.modeltranscript.show()})},remove_break:function(a){for(var c=0;c<this.breaks.length;c++)if(this.breaks[c].wordnumber==a){this.breaks.splice(c,1);break}this.controls.breaksfield.val(JSON.stringify(this.breaks)),b.debug(this.breaks)},register_break:function(a,c){this.breaks.push({wordnumber:a,audiotime:c}),this.controls.breaksfield.val(JSON.stringify(this.breaks)),b.debug(this.breaks)},markup_passage:function(){for(var b=0;b<this.breaks.length;b++){var c=this.breaks[b].wordnumber,d=a("#"+this.cd.spaceclass+"_"+c);d.addClass(this.cd.endspaceclass)}},player_get_time:function(){var a=this.controls.audioplayer[0];return a.currentTime},check_modelaudio_transcript_ready:function(c,d){var e=this;a.ajax({url:c+".txt",method:"HEAD",cache:!1,error:function(){b.debug("403 errors are normal here, till the file arrives back from transcriptoin"),setTimeout(function(){e.check_modelaudio_transcript_ready(c,d+5e3)},d)},success:function(a,b,f){switch(f.status){case 200:e.controls.modeltranscript.load(c+".txt"),e.controls.modeltranscriptbutton.show();break;default:setTimeout(function(){e.check_modelaudio_transcript_ready(c,d+5e3)},d)}}})},do_transcription_complete:function(){}}});