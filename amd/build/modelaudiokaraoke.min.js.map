{"version":3,"file":"modelaudiokaraoke.min.js","sources":["../src/modelaudiokaraoke.js"],"sourcesContent":["define(['jquery', 'core/log', 'mod_readaloud/definitions'], function($, log, def) {\r\n  \"use strict\"; // jshint ;_;\r\n  /*\r\n  This file runs preview and shadow and L-and-R modes, highlighting text as the player reaches it.\r\n   */\r\n\r\n  log.debug('Model Audio Karaoke: initialising');\r\n\r\n  return {\r\n    controls: {},\r\n    breaks: [],\r\n    endwordnumber: 0,\r\n    currentstartbreak: false,\r\n    modeling: false,\r\n\r\n    //class definitions\r\n    cd: {\r\n      audioplayerclass: def.audioplayerclass,\r\n      wordplayerclass: def.wordplayerclass,\r\n      wordclass: def.wordclass,\r\n      spaceclass: def.spaceclass,\r\n      endspaceclass: def.endspaceclass,\r\n      passagecontainer: def.passagecontainer,\r\n      activesentence: def.activesentence,\r\n      stopbutton: 'mod_readaloud_button_stop',\r\n      playbutton: 'mod_readaloud_button_play'\r\n    },\r\n\r\n    //init the module\r\n    init: function(opts) {\r\n      if (opts.breaks) {\r\n        var breaks = JSON.parse(opts.breaks);\r\n        this.set_breaks(breaks);\r\n      }\r\n      if (opts.modeling) {\r\n        this.modeling = true;\r\n      }\r\n      if (opts.audioplayerclass) {\r\n        this.cd.audioplayerclass = opts.audioplayerclass;\r\n      }\r\n\r\n      //register the controls\r\n      this.register_controls();\r\n\r\n      //register the end word number\r\n      this.endwordnumber = this.controls.eachword.length;\r\n\r\n      //register the events\r\n      this.register_events();\r\n    },\r\n\r\n    set_breaks: function(breaks) {\r\n      this.breaks = breaks;\r\n      this.sort_breaks();\r\n      this.number_breaks();\r\n    },\r\n\r\n    sort_breaks: function() {\r\n      this.breaks.sort(function(a, b) {\r\n        return a.audiotime - b.audiotime;\r\n      });\r\n    },\r\n\r\n    number_breaks: function(){\r\n      var that=this;\r\n        for (var i = 0; i < that.breaks.length; i++) {\r\n           that.breaks[i].breaknumber=i+1;\r\n        }\r\n    },\r\n\r\n    pause_audio: function() {\r\n      this.controls.audioplayer[0].pause();\r\n    },\r\n\r\n    play_audio: function() {\r\n      this.controls.audioplayer[0].play();\r\n    },\r\n\r\n    get_audio_time: function() {\r\n      return this.controls.audioplayer[0].currentTime;\r\n    },\r\n\r\n    set_audio_time: function(newtime) {\r\n      this.controls.audioplayer[0].currentTime=newtime;\r\n    },\r\n\r\n    fetch_audio_url: function() {\r\n      return this.controls.audioplayer.attr('src');\r\n    },\r\n\r\n    //load all the controls so we do not have to do it later\r\n    register_controls: function() {\r\n      this.controls.audioplayer = $('#' + this.cd.audioplayerclass);\r\n      this.controls.eachword = $('.' + this.cd.wordclass);\r\n      this.controls.eachspace = $('.' + this.cd.spaceclass);\r\n      this.controls.eachwordorspace = $('.' + this.cd.spaceclass + ',.' + this.cd.wordclass);\r\n      this.controls.passagecontainer = $(\".\" + this.cd.passagecontainer);\r\n      this.controls.stopbutton = $('#' + this.cd.stopbutton);\r\n      this.controls.playbutton = $('#' + this.cd.playbutton);\r\n    },\r\n\r\n    //attach the various event handlers we need\r\n    register_events: function() {\r\n      var that = this;\r\n\r\n      // Get the audio element\r\n      var aplayer = this.controls.audioplayer[0];\r\n\r\n      this.controls.playbutton.on('click', function() {\r\n        aplayer.play();\r\n      });\r\n\r\n      this.controls.stopbutton.on('click', function() {\r\n        aplayer.pause();\r\n        aplayer.currentTime=0;\r\n      });\r\n\r\n      //if we are not modeling we want to jump to the clicked location\r\n      //if we are modeling the meaning of a click is to place a marker, so we do not want to jump\r\n      this.controls.eachwordorspace.on('click', function() {\r\n        if (!that.modeling) {\r\n          var wordnumber = parseInt($(this).attr('data-wordnumber'));\r\n          var nearest_start_break = false;\r\n          for (var i = 0; i < that.breaks.length; i++) {\r\n            if (that.breaks[i].wordnumber < wordnumber) {\r\n              nearest_start_break = that.breaks[i];\r\n            } else {\r\n              //exit the loop;\r\n              break;\r\n            }\r\n          }\r\n          if (!nearest_start_break) {\r\n            //start from beginning OR do nothing\r\n          } else {\r\n            aplayer.pause();\r\n            aplayer.currentTime = nearest_start_break.audiotime;\r\n            aplayer.play();\r\n          }\r\n        } //end of if not modeling\r\n      }); //end of eachwordorspace\r\n\r\n\r\n      var timeupdate = function() {\r\n        var currentTime = aplayer.currentTime;\r\n        var startbreak = false;\r\n        var nextbreak = false;\r\n        for (var i = 0; i < that.breaks.length; i++) {\r\n\r\n          //if this is the last marked break (ie flow till end)\r\n          if (currentTime >= that.breaks[i].audiotime && i + 1 === that.breaks.length) {\r\n            startbreak = that.breaks[i];\r\n            nextbreak = {\r\n              wordnumber: that.endwordnumber + 1,\r\n              audiotime: 0\r\n            };\r\n            //if its just between two breaks (yay)\r\n          } else if (currentTime >= that.breaks[i].audiotime && currentTime < that.breaks[i + 1].audiotime) {\r\n            startbreak = that.breaks[i];\r\n            nextbreak = that.breaks[i + 1];\r\n            break;\r\n            //this is the first section\r\n          } else if (i === 0 && currentTime < that.breaks[i].audiotime && currentTime > 0) {\r\n            startbreak = {\r\n              wordnumber: 0,\r\n              audiotime: 0,\r\n              breaknumber: 0,\r\n            };\r\n            nextbreak = that.breaks[i];\r\n\r\n          }\r\n        }\r\n        //if the current break changed since last time, we go in here\r\n        // (on first time through we want to flag  \"changed\" so that is why a false current startbreak goes to \"changed\"\r\n        //in the special case that we reached the end of the passage we need to raise the eevent\r\n        var islastbreak = aplayer.ended && nextbreak.audiotime===0;\r\n        if (that.currentstartbreak === false || startbreak.wordnumber !== that.currentstartbreak.wordnumber || islastbreak) {\r\n          var finishedsentence = $('.' + that.cd.activesentence).text();\r\n          that.previousstartbreak = that.currentstartbreak;\r\n          that.currentstartbreak = startbreak;\r\n          that.controls.eachword.removeClass(that.cd.activesentence);\r\n          that.controls.eachspace.removeClass(that.cd.activesentence);\r\n          if (startbreak !== false && nextbreak !== false) {\r\n            for (var thewordnumber = startbreak.wordnumber + 1; thewordnumber <= nextbreak.wordnumber; thewordnumber++) {\r\n              $('#' + that.cd.spaceclass + '_' + thewordnumber).addClass((that.cd.activesentence));\r\n              $('#' + that.cd.wordclass + '_' + thewordnumber).addClass((that.cd.activesentence));\r\n            }\r\n          }\r\n          that.on_reach_audio_break(finishedsentence, that.previousstartbreak, that.currentstartbreak, that.breaks);\r\n        }\r\n      };\r\n\r\n      //Player events (onended, onpause, ontimeupdate)\r\n      var ended = function() {\r\n        that.controls.eachword.removeClass(that.cd.activesentence);\r\n        that.controls.eachspace.removeClass(that.cd.activesentence);\r\n        that.currentstartbreak = false;\r\n      };\r\n\r\n\r\n      aplayer.onended = ended;\r\n      aplayer.onpause = ended;\r\n      aplayer.ontimeupdate = timeupdate;\r\n    }, //end of register events\r\n\r\n\r\n    on_reach_audio_break: function(sentence, oldbreak, newbreak, breaks) {\r\n      log.debug(sentence);\r\n      log.debug(oldbreak);\r\n      log.debug(newbreak);\r\n    }\r\n\r\n  }; //end of return value\r\n});"],"names":["define","$","log","def","debug","controls","breaks","endwordnumber","currentstartbreak","modeling","cd","audioplayerclass","wordplayerclass","wordclass","spaceclass","endspaceclass","passagecontainer","activesentence","stopbutton","playbutton","init","opts","JSON","parse","set_breaks","register_controls","this","eachword","length","register_events","sort_breaks","number_breaks","sort","a","b","audiotime","i","breaknumber","pause_audio","audioplayer","pause","play_audio","play","get_audio_time","currentTime","set_audio_time","newtime","fetch_audio_url","attr","eachspace","eachwordorspace","that","aplayer","on","wordnumber","parseInt","nearest_start_break","ended","removeClass","onended","onpause","ontimeupdate","startbreak","nextbreak","islastbreak","finishedsentence","text","previousstartbreak","thewordnumber","addClass","on_reach_audio_break","sentence","oldbreak","newbreak"],"mappings":"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"}