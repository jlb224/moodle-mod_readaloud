{"version":3,"sources":["../src/modelaudiokaraoke.js"],"names":["define","$","log","def","debug","controls","breaks","endwordnumber","currentstartbreak","modeling","cd","audioplayerclass","wordplayerclass","wordclass","spaceclass","endspaceclass","passagecontainer","activesentence","stopbutton","playbutton","init","opts","JSON","parse","register_controls","eachword","length","register_events","set_breaks","sort_breaks","sort","a","b","audiotime","pause_audio","trigger","play_audio","fetch_audio_url","audioplayer","attr","eachspace","eachwordorspace","that","aplayer","on","play","pause","wordnumber","parseInt","nearest_start_break","i","currentTime","ended","removeClass","onended","onpause","ontimeupdate","startbreak","nextbreak","finishedsentence","text","previousstartbreak","thewordnumber","addClass","on_reach_audio_break","sentence","oldbreak","newbreak"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'mod_readaloud/definitions'], function($, log, def) {\n  \"use strict\"; // jshint ;_;\n  /*\n  This file runs preview and shadow and L-and-R modes, highlighting text as the player reaches it.\n   */\n\n  log.debug('Model Audio Karaoke: initialising');\n\n  return {\n    controls: {},\n    breaks: [],\n    endwordnumber: 0,\n    currentstartbreak: false,\n    modeling: false,\n\n    //class definitions\n    cd: {\n      audioplayerclass: def.audioplayerclass,\n      wordplayerclass: def.wordplayerclass,\n      wordclass: def.wordclass,\n      spaceclass: def.spaceclass,\n      endspaceclass: def.endspaceclass,\n      passagecontainer: def.passagecontainer,\n      activesentence: def.activesentence,\n      stopbutton: 'mod_readaloud_button_stop',\n      playbutton: 'mod_readaloud_button_play'\n    },\n\n    //init the module\n    init: function(opts) {\n      if (opts.breaks) {\n        this.breaks = JSON.parse(opts.breaks);\n      }\n      if (opts.modeling) {\n        this.modeling = true;\n      }\n      if (opts.audioplayerclass) {\n        this.cd.audioplayerclass = opts.audioplayerclass;\n      }\n\n      //register the controls\n      this.register_controls();\n\n      //register the end word number\n      this.endwordnumber = this.controls.eachword.length;\n\n      //register the events\n      this.register_events();\n    },\n\n    set_breaks: function(breaks) {\n      this.breaks = breaks;\n      this.sort_breaks();\n    },\n\n    sort_breaks: function() {\n      this.breaks.sort(function(a, b) {\n        return a.audiotime - b.audiotime\n      });\n    },\n\n    pause_audio: function() {\n      this.controls.stopbutton.trigger('click');\n    },\n\n    play_audio: function() {\n      this.controls.playbutton.trigger('click');\n    },\n\n    fetch_audio_url: function() {\n      return this.controls.audioplayer.attr('src');\n    },\n\n    //load all the controls so we do not have to do it later\n    register_controls: function() {\n      this.controls.audioplayer = $('#' + this.cd.audioplayerclass);\n      this.controls.eachword = $('.' + this.cd.wordclass);\n      this.controls.eachspace = $('.' + this.cd.spaceclass);\n      this.controls.eachwordorspace = $('.' + this.cd.spaceclass + ',.' + this.cd.wordclass);\n      this.controls.passagecontainer = $(\".\" + this.cd.passagecontainer);\n      this.controls.stopbutton = $('#' + this.cd.stopbutton);\n      this.controls.playbutton = $('#' + this.cd.playbutton);\n    },\n\n    //attach the various event handlers we need\n    register_events: function() {\n      var that = this;\n\n      // Get the audio element\n      var aplayer = this.controls.audioplayer[0];\n\n      this.controls.playbutton.on('click', function() {\n        aplayer.play();\n      });\n\n      this.controls.stopbutton.on('click', function() {\n        aplayer.pause();\n      });\n\n      //if we are not modeling we want to jump to the clicked location\n      //if we are modeling the meaning of a click is to place a marker, so we do not want to jump\n      if (!this.modeling) {\n        this.controls.eachwordorspace.on('click', function() {\n          var wordnumber = parseInt($(this).attr('data-wordnumber'));\n          var nearest_start_break = false;\n          for (var i = 0; i < that.breaks.length; i++) {\n            if (that.breaks[i].wordnumber < wordnumber) {\n              nearest_start_break = that.breaks[i];\n            } else {\n              //exit the loop;\n              break;\n            }\n          }\n          if (!nearest_start_break) {\n            //start from beginning OR do nothing\n          } else {\n            aplayer.pause();\n            aplayer.currentTime = nearest_start_break.audiotime;\n            aplayer.play();\n          }\n        }); //end of eachwordorspace\n      } //end of if not modeling\n\n      //Player events (onended, onpause, ontimeupdate)\n      var ended = function() {\n        that.controls.eachword.removeClass(that.cd.activesentence);\n        that.controls.eachspace.removeClass(that.cd.activesentence);\n        that.currentstartbreak = false;\n      };\n\n      aplayer.onended = ended;\n      aplayer.onpause = ended;\n\n      aplayer.ontimeupdate = function() {\n        var currentTime = aplayer.currentTime;\n        var startbreak = false;\n        var nextbreak = false;\n        for (var i = 0; i < that.breaks.length; i++) {\n          //if this is the last marked break (ie flow till end)\n          if (currentTime >= that.breaks[i].audiotime && i + 1 === that.breaks.length) {\n            startbreak = that.breaks[i];\n            nextbreak = {\n              wordnumber: that.endwordnumber + 1,\n              audiotime: 0\n            };\n            //if its just between two breaks (yay)\n          } else if (currentTime >= that.breaks[i].audiotime && currentTime < that.breaks[i + 1].audiotime) {\n            startbreak = that.breaks[i];\n            nextbreak = that.breaks[i + 1];\n            break;\n            //this is the first section\n          } else if (i === 0 && currentTime < that.breaks[i].audiotime && currentTime > 0) {\n            startbreak = {\n              wordnumber: 0,\n              audiotime: 0\n            };\n            nextbreak = that.breaks[i];\n\n          }\n        }\n        //if the current break changed since last time, we do not want to do anything\n        // (on first time through we want to flag  \"changed\" so that is why a false current startbreak goes to \"changed\"\n\n        if (that.currentstartbreak === false || startbreak.wordnumber !== that.currentstartbreak.wordnumber) {\n          var finishedsentence = $('.' + that.cd.activesentence).text();\n          that.previousstartbreak = that.currentstartbreak;\n          that.currentstartbreak = startbreak;\n          that.controls.eachword.removeClass(that.cd.activesentence);\n          that.controls.eachspace.removeClass(that.cd.activesentence);\n          if (startbreak !== false && nextbreak !== false) {\n            for (var thewordnumber = startbreak.wordnumber + 1; thewordnumber <= nextbreak.wordnumber; thewordnumber++) {\n              $('#' + that.cd.spaceclass + '_' + thewordnumber).addClass((that.cd.activesentence));\n              $('#' + that.cd.wordclass + '_' + thewordnumber).addClass((that.cd.activesentence));\n            }\n          }\n          that.on_reach_audio_break(finishedsentence, that.previousstartbreak, that.currentstartbreak);\n        }\n      };\n    }, //end of register events\n\n\n    on_reach_audio_break: function(sentence, oldbreak, newbreak) {\n      log.debug(sentence);\n      log.debug(oldbreak);\n      log.debug(newbreak);\n    }\n\n  }; //end of return value\n});"],"file":"modelaudiokaraoke.min.js"}