define ("mod_readaloud/activitycontroller",["jquery","jqueryui","core/log","mod_readaloud/definitions","mod_readaloud/recorderhelper","mod_readaloud/modelaudiokaraoke","mod_readaloud/transcriber-lazy","core/ajax","core/notification"],function(a,b,c,d,e,f,g,h,i){"use strict";c.debug("Activity controller: initialising");return{cmid:null,activitydata:null,holderid:null,recorderid:null,playerid:null,sorryboxid:null,controls:null,ra_recorder:null,rec_time_start:0,enableshadow:!1,enablepreview:!1,letsshadow:!1,streamingresults:!1,passagefinished:d.passagefinished,clone:function clone(){return a.extend(!0,{},this)},init:function init(b){var e=this.clone(),f="#amdopts_"+b.widgetid,h=a(f).get(0);if(h){e.activitydata=JSON.parse(h.value);a(f).remove()}else{c.debug("Read Aloud Test Controller: No config found on page. Giving up.");return}e.cmid=b.cmid;e.holderid=b.widgetid+"_holder";e.recorderid=b.widgetid+"_recorder";e.playerid=b.widgetid+"_player";e.sorryboxid=b.widgetid+"_sorrybox";if(!e.is_browser_ok()){a("#"+e.sorryboxid).show();return}e.enableshadow=e.activitydata.enableshadow;e.enablepreview=e.activitydata.enablepreview;e.setupmodelaudio();var i={language:e.activitydata.language,region:e.activitydata.region,token:e.activitydata.token,parent:e.activitydata.parent,owner:e.activitydata.owner,appid:e.activitydata.appid,expiretime:e.activitydata.expiretime,transcriber:e.activitydata.transcriber};if(i.transcriber==d.transcriber_amazonstreaming){g.init(i);g.onFinalResult=function(a,b){e.streamingresults.push(b);c.debug(e.streamingresults)};g.onPartialResult=function(){}}e.setup_recorder();e.process_html(e.activitydata);e.register_events();if(e.enableshadow||e.enablepreview){e.domenulayout()}else{e.doreadinglayout()}},setupmodelaudio:function setupmodelaudio(){var a={breaks:this.activitydata.breaks,audioplayerclass:this.activitydata.audioplayerclass};f.init(a)},process_html:function process_html(b){var c={hider:a("."+b.hider),introbox:a(".mod_intro_box"),progresscontainer:a("."+b.progresscontainer),feedbackcontainer:a("."+b.feedbackcontainer),errorcontainer:a("."+b.errorcontainer),passagecontainer:a("."+b.passagecontainer),recordingcontainer:a("."+b.recordingcontainer),dummyrecorder:a("."+b.dummyrecorder),recordercontainer:a("."+b.recordercontainer),menubuttonscontainer:a("."+b.menubuttonscontainer),menuinstructionscontainer:a("."+b.menuinstructionscontainer),activityinstructionscontainer:a("."+b.activityinstructionscontainer),recinstructionscontainerright:a("."+b.recinstructionscontainerright),recinstructionscontainerleft:a("."+b.recinstructionscontainerleft),allowearlyexit:a("."+b.allowearlyexit),wheretonextcontainer:a("."+b.wheretonextcontainer),modelaudioplayer:a("#"+b.modelaudioplayer),startpreviewbutton:a("#"+b.startpreviewbutton),startreadingbutton:a("#"+b.startreadingbutton),startshadowbutton:a("#"+b.startshadowbutton),returnmenubutton:a("#"+b.returnmenubutton),stopandplay:a("#"+b.stopandplay)};this.controls=c},is_browser_ok:function is_browser_ok(){return navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},setup_recorder:function setup_recorder(){var a=this,b=function(){a.passagerecorded=!0;if(a.enableshadow&&a.letsshadow){a.controls.modelaudioplayer[0].play()}};e.init(a.activitydata,function on_recording_start(){a.rec_time_start=new Date().getTime();a.dopassagelayout();a.controls.passagecontainer.show(1e3,b);if(a.activitydata.transcriber==d.transcriber_amazonstreaming){if(g.active){return}a.streamingresults=[];window.navigator.mediaDevices.getUserMedia({video:!1,audio:!0}).then(function(a){g.start(a,g)}).catch(function(a){c.debug(a);c.debug("There was an error streaming your audio to Amazon Transcribe. Please try again.")})}},function on_recording_end(){var b=new Date().getTime();if(3e3>b-a.rec_time_start){return}a.douploadlayout();if(a.enableshadow&&a.letsshadow){a.controls.modelaudioplayer[0].currentTime=0;a.controls.modelaudioplayer[0].pause()}if(a.activitydata.transcriber==d.transcriber_amazonstreaming){if(!g.active){return}g.closeSocket()}},function on_audio_processing(b){var c=new Date().getTime(),e=c-a.rec_time_start;if(0<e){e=Math.ceil(e/1e3)}if(a.activitydata.transcriber==d.transcriber_amazonstreaming&&a.streamingresults&&0<a.streamingresults.length){a.send_streaming_submission(b.mediaurl,e,a.streamingresults)}else{a.send_submission(b.mediaurl,e)}a.dofinishedlayout()})},register_events:function register_events(){var a=this;a.controls.startpreviewbutton.click(function(){a.dopreviewlayout()});a.controls.startreadingbutton.click(function(){a.letsshadow=!1;a.doreadinglayout()});a.controls.startshadowbutton.click(function(){a.letsshadow=!0;a.doreadinglayout()});a.controls.returnmenubutton.click(function(){a.controls.modelaudioplayer[0].currentTime=0;a.controls.modelaudioplayer[0].pause();a.domenulayout()})},fetch_presigned_streaming_url:function fetch_presigned_streaming_url(a){var b=this;h.call([{methodname:"local_cpapi_fetch_streamingtranscriber",args:{cmid:b.cmid,filename:a,rectime:rectime,awsresults:JSON.stringify(streamingresults)},done:function done(a){var b=JSON.parse(a);if(b){switch(b.success){case!0:c.debug("attempted submission accepted");break;case!1:default:c.debug("attempted item evaluation failure");if(b.message){c.debug("message: "+b.message)}}}},fail:i.exception}])},send_streaming_submission:function send_streaming_submission(a,b,d){var e=this;h.call([{methodname:"mod_readaloud_submit_streaming_attempt",args:{cmid:e.cmid,filename:a,rectime:b,awsresults:JSON.stringify(d)},done:function done(a){var b=JSON.parse(a);if(b){switch(b.success){case!0:c.debug("attempted submission accepted");break;case!1:default:c.debug("attempted item evaluation failure");if(b.message){c.debug("message: "+b.message)}}}},fail:i.exception}])},send_submission:function send_submission(a,b){var d=this;h.call([{methodname:"mod_readaloud_submit_regular_attempt",args:{cmid:d.cmid,filename:a,rectime:b},done:function done(a){var b=JSON.parse(a);if(b){switch(b.success){case!0:c.debug("attempted submission accepted");break;case!1:default:c.debug("attempted item evaluation failure");if(b.message){c.debug("message: "+b.message)}}}},fail:i.exception}])},doreadinglayout:function doreadinglayout(){var a=this;a.controls.hider.fadeOut("fast");a.controls.activityinstructionscontainer.show();a.controls.recordingcontainer.show();a.controls.menuinstructionscontainer.hide();a.controls.menubuttonscontainer.hide();a.controls.returnmenubutton.show();a.controls.progresscontainer.hide();a.controls.passagecontainer.hide();a.controls.feedbackcontainer.hide();a.controls.wheretonextcontainer.hide();a.controls.stopandplay.hide()},domenulayout:function domenulayout(){var a=this;a.controls.menuinstructionscontainer.show();a.controls.menubuttonscontainer.show();a.controls.activityinstructionscontainer.hide();a.controls.returnmenubutton.hide();a.controls.progresscontainer.hide();a.controls.passagecontainer.hide();a.controls.recordingcontainer.hide();a.controls.feedbackcontainer.hide();a.controls.wheretonextcontainer.hide();a.controls.modelaudioplayer.hide();a.controls.hider.hide();a.controls.stopandplay.hide()},dopreviewlayout:function dopreviewlayout(){var a=this;a.controls.passagecontainer.show();a.controls.returnmenubutton.show();a.controls.modelaudioplayer.hide();a.controls.stopandplay.show();a.controls.menubuttonscontainer.hide();a.controls.hider.hide();a.controls.progresscontainer.hide();a.controls.menuinstructionscontainer.hide();a.controls.activityinstructionscontainer.hide();a.controls.recordingcontainer.hide();a.controls.feedbackcontainer.hide();a.controls.wheretonextcontainer.hide();a.controls.stopandplay.show()},dopassagelayout:function dopassagelayout(){var a=this;a.controls.introbox.hide()},douploadlayout:function douploadlayout(){var a=this;a.controls.passagecontainer.addClass(a.passagefinished);a.controls.hider.fadeIn("fast");a.controls.progresscontainer.fadeIn("fast")},dofinishedlayout:function dofinishedlayout(){var a=this;a.controls.hider.fadeOut("fast");a.controls.progresscontainer.fadeOut("fast");a.controls.activityinstructionscontainer.hide();a.controls.passagecontainer.hide();a.controls.recordingcontainer.hide();a.controls.feedbackcontainer.show();a.controls.wheretonextcontainer.show();a.controls.returnmenubutton.hide()},doerrorlayout:function doerrorlayout(){var a=this;a.controls.hider.fadeOut("fast");a.controls.progresscontainer.fadeOut("fast");a.controls.passagecontainer.hide();a.controls.recordingcontainer.hide();a.controls.errorcontainer.show();a.controls.wheretonextcontainer.show()}}});
//# sourceMappingURL=activitycontroller.min.js.map
