define(["jquery","jqueryui","core/log","mod_readaloud/definitions","mod_readaloud/recorderhelper","mod_readaloud/modelaudiokaraoke","mod_readaloud/transcriber","core/ajax","core/notification"],function(a,b,c,d,e,f,g,h,i){"use strict";return c.debug("Activity controller: initialising"),{cmid:null,activitydata:null,holderid:null,recorderid:null,playerid:null,sorryboxid:null,controls:null,ra_recorder:null,rec_time_start:0,enableshadow:!1,enablepreview:!1,letsshadow:!1,streamingresults:!1,passagefinished:d.passagefinished,clone:function(){return a.extend(!0,{},this)},init:function(b){var e=this.clone(),f="#amdopts_"+b.widgetid,h=a(f).get(0);if(!h)return void c.debug("Read Aloud Test Controller: No config found on page. Giving up.");if(e.activitydata=JSON.parse(h.value),a(f).remove(),e.cmid=b.cmid,e.holderid=b.widgetid+"_holder",e.recorderid=b.widgetid+"_recorder",e.playerid=b.widgetid+"_player",e.sorryboxid=b.widgetid+"_sorrybox",!e.is_browser_ok())return void a("#"+e.sorryboxid).show();e.enableshadow=e.activitydata.enableshadow,e.enablepreview=e.activitydata.enablepreview,e.setupmodelaudio();var i={};i.language=e.activitydata.language,i.region=e.activitydata.region,i.accessid=e.activitydata.accessid,i.secretkey=e.activitydata.secretkey,i.transcriber=e.activitydata.transcriber,i.transcriber==d.transcriber_amazonstreaming&&(g.init(i),g.onFinalResult=function(a,b){e.streamingresults.push(b),c.debug(e.streamingresults)},g.onPartialResult=function(a,b){}),e.setup_recorder(),e.process_html(e.activitydata),e.register_events(),e.enableshadow||e.enablepreview?e.domenulayout():e.doreadinglayout()},setupmodelaudio:function(){var a={breaks:this.activitydata.breaks,audioplayerclass:this.activitydata.audioplayerclass};f.init(a)},process_html:function(b){var c={hider:a("."+b.hider),introbox:a(".mod_intro_box"),progresscontainer:a("."+b.progresscontainer),feedbackcontainer:a("."+b.feedbackcontainer),errorcontainer:a("."+b.errorcontainer),passagecontainer:a("."+b.passagecontainer),recordingcontainer:a("."+b.recordingcontainer),dummyrecorder:a("."+b.dummyrecorder),recordercontainer:a("."+b.recordercontainer),menubuttonscontainer:a("."+b.menubuttonscontainer),menuinstructionscontainer:a("."+b.menuinstructionscontainer),activityinstructionscontainer:a("."+b.activityinstructionscontainer),recinstructionscontainerright:a("."+b.recinstructionscontainerright),recinstructionscontainerleft:a("."+b.recinstructionscontainerleft),allowearlyexit:a("."+b.allowearlyexit),wheretonextcontainer:a("."+b.wheretonextcontainer),modelaudioplayer:a("#"+b.modelaudioplayer),startpreviewbutton:a("#"+b.startpreviewbutton),startreadingbutton:a("#"+b.startreadingbutton),startshadowbutton:a("#"+b.startshadowbutton),returnmenubutton:a("#"+b.returnmenubutton)};this.controls=c},is_browser_ok:function(){return navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},setup_recorder:function(){var a=this,b=function(){a.passagerecorded=!0,a.enableshadow&&a.letsshadow&&a.controls.modelaudioplayer[0].play()},f=function(e){if(a.rec_time_start=(new Date).getTime(),a.dopassagelayout(),a.controls.passagecontainer.show(1e3,b),a.activitydata.transcriber==d.transcriber_amazonstreaming){if(g.active)return;a.streamingresults=[],window.navigator.mediaDevices.getUserMedia({video:!1,audio:!0}).then(function(a){g.start(a,g)})["catch"](function(a){c.debug(a),c.debug("There was an error streaming your audio to Amazon Transcribe. Please try again.")})}},h=function(b){var c=(new Date).getTime();if(!(c-a.rec_time_start<3e3)&&(a.douploadlayout(),a.enableshadow&&a.letsshadow&&(a.controls.modelaudioplayer[0].currentTime=0,a.controls.modelaudioplayer[0].pause()),a.activitydata.transcriber==d.transcriber_amazonstreaming)){if(!g.active)return;g.closeSocket()}},i=function(b){var c=(new Date).getTime(),e=c-a.rec_time_start;e>0&&(e=Math.ceil(e/1e3)),a.activitydata.transcriber==d.transcriber_amazonstreaming&&a.streamingresults&&a.streamingresults.length>0?a.send_streaming_submission(b.mediaurl,e,a.streamingresults):a.send_submission(b.mediaurl,e),a.dofinishedlayout()};e.init(a.activitydata,f,h,i)},register_events:function(){var a=this;a.controls.startpreviewbutton.click(function(){a.dopreviewlayout()}),a.controls.startreadingbutton.click(function(){a.letsshadow=!1,a.doreadinglayout()}),a.controls.startshadowbutton.click(function(){a.letsshadow=!0,a.doreadinglayout()}),a.controls.returnmenubutton.click(function(){a.controls.modelaudioplayer[0].currentTime=0,a.controls.modelaudioplayer[0].pause(),a.domenulayout()})},send_streaming_submission:function(a,b,d){var e=this;h.call([{methodname:"mod_readaloud_submit_streaming_attempt",args:{cmid:e.cmid,filename:a,rectime:b,awsresults:JSON.stringify(d)},done:function(a){var b=JSON.parse(a);if(b)switch(b.success){case!0:c.debug("attempted submission accepted");break;case!1:default:c.debug("attempted item evaluation failure"),b.message&&c.debug("message: "+b.message)}},fail:i.exception}])},send_submission:function(a,b){var d=this;h.call([{methodname:"mod_readaloud_submit_regular_attempt",args:{cmid:d.cmid,filename:a,rectime:b},done:function(a){var b=JSON.parse(a);if(b)switch(b.success){case!0:c.debug("attempted submission accepted");break;case!1:default:c.debug("attempted item evaluation failure"),b.message&&c.debug("message: "+b.message)}},fail:i.exception}])},doreadinglayout:function(){var a=this;a.controls.hider.fadeOut("fast"),a.controls.activityinstructionscontainer.show(),a.controls.recordingcontainer.show(),a.controls.menuinstructionscontainer.hide(),a.controls.menubuttonscontainer.hide(),a.controls.returnmenubutton.hide(),a.controls.progresscontainer.hide(),a.controls.passagecontainer.hide(),a.controls.feedbackcontainer.hide(),a.controls.wheretonextcontainer.hide()},domenulayout:function(){var a=this;a.controls.menuinstructionscontainer.show(),a.controls.menubuttonscontainer.show(),a.controls.activityinstructionscontainer.hide(),a.controls.returnmenubutton.hide(),a.controls.progresscontainer.hide(),a.controls.passagecontainer.hide(),a.controls.recordingcontainer.hide(),a.controls.feedbackcontainer.hide(),a.controls.wheretonextcontainer.hide(),a.controls.modelaudioplayer.hide(),a.controls.hider.hide()},dopreviewlayout:function(){var a=this;a.controls.passagecontainer.show(),a.controls.returnmenubutton.show(),a.controls.modelaudioplayer.show(),a.controls.menubuttonscontainer.hide(),a.controls.hider.hide(),a.controls.progresscontainer.hide(),a.controls.menuinstructionscontainer.hide(),a.controls.activityinstructionscontainer.hide(),a.controls.recordingcontainer.hide(),a.controls.feedbackcontainer.hide(),a.controls.wheretonextcontainer.hide()},dopassagelayout:function(){var a=this;a.controls.introbox.hide()},douploadlayout:function(){var a=this;a.controls.passagecontainer.addClass(a.passagefinished),a.controls.hider.fadeIn("fast"),a.controls.progresscontainer.fadeIn("fast")},dofinishedlayout:function(){var a=this;a.controls.hider.fadeOut("fast"),a.controls.progresscontainer.fadeOut("fast"),a.controls.activityinstructionscontainer.hide(),a.controls.passagecontainer.hide(),a.controls.recordingcontainer.hide(),a.controls.feedbackcontainer.show(),a.controls.wheretonextcontainer.show()},doerrorlayout:function(){var a=this;a.controls.hider.fadeOut("fast"),a.controls.progresscontainer.fadeOut("fast"),a.controls.passagecontainer.hide(),a.controls.recordingcontainer.hide(),a.controls.errorcontainer.show(),a.controls.wheretonextcontainer.show()}}});