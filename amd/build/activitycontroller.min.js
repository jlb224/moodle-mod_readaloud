define(["jquery","jqueryui","core/log","mod_readaloud/definitions","mod_readaloud/recorderhelper"],function(a,b,c,d,e){"use strict";return c.debug("Activity controller: initialising"),{cmid:null,activitydata:null,holderid:null,recorderid:null,playerid:null,sorryboxid:null,controls:null,ra_recorder:null,rec_time_start:0,passagefinished:d.passagefinished,clone:function(){return a.extend(!0,{},this)},init:function(b){var d=this.clone(),e="#amdopts_"+b.widgetid,f=a(e).get(0);return f?(d.activitydata=JSON.parse(f.value),a(e).remove(),d.cmid=b.cmid,d.holderid=b.widgetid+"_holder",d.recorderid=b.widgetid+"_recorder",d.playerid=b.widgetid+"_player",d.sorryboxid=b.widgetid+"_sorrybox",d.is_browser_ok()?(d.setup_recorder(),d.process_html(d.activitydata),void d.register_events()):void a("#"+d.sorryboxid).show()):void c.debug("Read Aloud Test Controller: No config found on page. Giving up.")},process_html:function(b){var c={hider:a("."+b.hider),introbox:a(".mod_intro_box"),progresscontainer:a("."+b.progresscontainer),feedbackcontainer:a("."+b.feedbackcontainer),errorcontainer:a("."+b.errorcontainer),passagecontainer:a("."+b.passagecontainer),recordingcontainer:a("."+b.recordingcontainer),dummyrecorder:a("."+b.dummyrecorder),recordercontainer:a("."+b.recordercontainer),instructionscontainer:a("."+b.instructionscontainer),recinstructionscontainerright:a("."+b.recinstructionscontainerright),recinstructionscontainerleft:a("."+b.recinstructionscontainerleft),allowearlyexit:a("."+b.allowearlyexit),wheretonextcontainer:a("."+b.wheretonextcontainer)};this.controls=c},beginall:function(){var a=this;a.passagerecorded=!0},is_browser_ok:function(){return navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},setup_recorder:function(){var a=this,b=function(b){a.rec_time_start=(new Date).getTime(),a.dopassagelayout(),a.controls.passagecontainer.show(1e3,a.beginall)},c=function(b){var c=(new Date).getTime();c-a.rec_time_start<3e3||a.douploadlayout()},d=function(b){var c=(new Date).getTime(),d=c-a.rec_time_start;d>0&&(d=Math.ceil(d/1e3)),a.send_submission(b.mediaurl,d),a.dofinishedlayout()};e.init(a.activitydata,b,c,d)},register_events:function(){},send_submission:function(a,b){var d=new XMLHttpRequest,e=this;d.onreadystatechange=function(a){if(4===this.readyState)if(200===d.status){c.debug("ok we got an attempt submission response");var b=d.responseText,e=JSON.parse(b);if(e)switch(e.success){case!0:c.debug("attempted submission accepted");break;case!1:default:c.debug("attempted item evaluation failure"),e.message&&c.debug("message: "+e.message)}}else c.debug("Not 200 response:"+d.status)};var f="cmid="+e.cmid+"&filename="+encodeURIComponent(a)+"&rectime="+b;d.open("POST",M.cfg.wwwroot+"/mod/readaloud/ajaxhelper.php",!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.setRequestHeader("Cache-Control","no-cache"),d.send(f)},dopassagelayout:function(){var a=this;a.controls.introbox.hide(),a.controls.allowearlyexit},douploadlayout:function(){var a=this;a.controls.passagecontainer.addClass(a.passagefinished),a.controls.hider.fadeIn("fast"),a.controls.progresscontainer.fadeIn("fast")},dofinishedlayout:function(){var a=this;a.controls.hider.fadeOut("fast"),a.controls.progresscontainer.fadeOut("fast"),a.controls.instructionscontainer.hide(),a.controls.passagecontainer.hide(),a.controls.recordingcontainer.hide(),a.controls.feedbackcontainer.show(),a.controls.wheretonextcontainer.show()},doerrorlayout:function(){var a=this;a.controls.hider.fadeOut("fast"),a.controls.progresscontainer.fadeOut("fast"),a.controls.passagecontainer.hide(),a.controls.recordingcontainer.hide(),a.controls.errorcontainer.show(),a.controls.wheretonextcontainer.show()}}});