define(["jquery","jqueryui","core/log","mod_readaloud/definitions","mod_readaloud/recorderhelper","mod_readaloud/modelaudiokaraoke","core/ajax","core/notification"],function(a,b,c,d,e,f,g,h){"use strict";return c.debug("Activity controller: initialising"),{cmid:null,activitydata:null,holderid:null,recorderid:null,playerid:null,sorryboxid:null,controls:null,ra_recorder:null,rec_time_start:0,enableshadow:!1,enablepreview:!1,letsshadow:!1,streamingresults:!1,passagefinished:d.passagefinished,clone:function(){return a.extend(!0,{},this)},init:function(b){var d=this.clone(),e="#amdopts_"+b.widgetid,f=a(e).get(0);return f?(d.activitydata=JSON.parse(f.value),a(e).remove(),d.cmid=b.cmid,d.holderid=b.widgetid+"_holder",d.recorderid=b.widgetid+"_recorder",d.playerid=b.widgetid+"_player",d.sorryboxid=b.widgetid+"_sorrybox",d.is_browser_ok()?(d.enableshadow=d.activitydata.enableshadow,d.enablepreview=d.activitydata.enablepreview,d.setupmodelaudio(),d.setup_recorder(),d.process_html(d.activitydata),d.register_events(),d.enableshadow||d.enablepreview,d.domenulayout(),void 0):void a("#"+d.sorryboxid).show()):void c.debug("Read Aloud Test Controller: No config found on page. Giving up.")},setupmodelaudio:function(){var a={breaks:this.activitydata.breaks,audioplayerclass:this.activitydata.audioplayerclass};f.init(a)},process_html:function(b){var c={hider:a("."+b.hider),introbox:a(".mod_intro_box"),progresscontainer:a("."+b.progresscontainer),feedbackcontainer:a("."+b.feedbackcontainer),errorcontainer:a("."+b.errorcontainer),passagecontainer:a("."+b.passagecontainer),recordingcontainer:a("."+b.recordingcontainer),dummyrecorder:a("."+b.dummyrecorder),recordercontainer:a("."+b.recordercontainer),menubuttonscontainer:a("."+b.menubuttonscontainer),menuinstructionscontainer:a("."+b.menuinstructionscontainer),activityinstructionscontainer:a("."+b.activityinstructionscontainer),recinstructionscontainerright:a("."+b.recinstructionscontainerright),recinstructionscontainerleft:a("."+b.recinstructionscontainerleft),allowearlyexit:a("."+b.allowearlyexit),wheretonextcontainer:a("."+b.wheretonextcontainer),modelaudioplayer:a("#"+b.modelaudioplayer),startpreviewbutton:a("#"+b.startpreviewbutton),startreadingbutton:a("#"+b.startreadingbutton),startshadowbutton:a("#"+b.startshadowbutton),returnmenubutton:a("#"+b.returnmenubutton),stopandplay:a("#"+b.stopandplay),smallreportcontainer:a("."+b.smallreportcontainer)};this.controls=c},is_browser_ok:function(){return navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},setup_recorder:function(){var a=this,b=function(){a.passagerecorded=!0,a.enableshadow&&a.letsshadow&&a.controls.modelaudioplayer[0].play()},f=function(b){var e=(b.capturedspeech,b.speechresults);a.activitydata.transcriber==d.transcriber_amazonstreaming&&(a.streamingresults.push(e),c.debug(a.streamingresults))},g=function(c){a.rec_time_start=(new Date).getTime(),a.dopassagelayout(),a.controls.passagecontainer.show(1e3,b),a.activitydata.transcriber==d.transcriber_amazonstreaming&&(a.streamingresults=[])},h=function(b){var c=(new Date).getTime();c-a.rec_time_start<3e3||(a.douploadlayout(),a.enableshadow&&a.letsshadow&&(a.controls.modelaudioplayer[0].currentTime=0,a.controls.modelaudioplayer[0].pause()))},i=function(b){var c=(new Date).getTime(),e=c-a.rec_time_start;e>0&&(e=Math.ceil(e/1e3)),a.activitydata.transcriber==d.transcriber_amazonstreaming&&a.streamingresults&&a.streamingresults.length>0?setTimeout(a.send_streaming_submission,1500,a,b.mediaurl,e):(a.send_submission(b.mediaurl,e),a.dofinishedlayout())};e.init(a.activitydata,g,h,i,f)},register_events:function(){var a=this;a.controls.startpreviewbutton.click(function(b){a.dopreviewlayout()}),a.controls.startpreviewbutton.keypress(function(b){32!=b.which&&13!=b.which||(a.dopreviewlayout(),b.preventDefault())}),a.controls.startreadingbutton.click(function(b){a.letsshadow=!1,a.doreadinglayout()}),a.controls.startreadingbutton.keypress(function(b){32!=b.which&&13!=b.which||(a.letsshadow=!1,a.doreadinglayout(),b.preventDefault())}),a.controls.startshadowbutton.click(function(b){a.letsshadow=!0,a.doreadinglayout()}),a.controls.startshadowbutton.keypress(function(b){32!=b.which&&13!=b.which||(a.letsshadow=!0,a.doreadinglayout(),b.preventDefault())}),a.controls.returnmenubutton.click(function(b){a.controls.modelaudioplayer[0].currentTime=0,a.controls.modelaudioplayer[0].pause(),a.domenulayout()})},send_streaming_submission:function(a,b,d){var e=a.streamingresults;g.call([{methodname:"mod_readaloud_submit_streaming_attempt",args:{cmid:a.cmid,filename:b,rectime:d,awsresults:JSON.stringify(e)},done:function(b){var d=JSON.parse(b);if(d)switch(d.success){case!0:c.debug("attempted submission accepted");break;case!1:default:c.debug("attempted item evaluation failure"),d.message&&c.debug("message: "+d.message)}a.dofinishedlayout()},fail:h.exception}])},send_submission:function(a,b){var d=this;g.call([{methodname:"mod_readaloud_submit_regular_attempt",args:{cmid:d.cmid,filename:a,rectime:b},done:function(a){var b=JSON.parse(a);if(b)switch(b.success){case!0:c.debug("attempted submission accepted");break;case!1:default:c.debug("attempted item evaluation failure"),b.message&&c.debug("message: "+b.message)}},fail:h.exception}])},doreadinglayout:function(){var a=this;a.controls.hider.fadeOut("fast"),a.controls.activityinstructionscontainer.show(),a.controls.recordingcontainer.show(),a.controls.menuinstructionscontainer.hide(),a.controls.menubuttonscontainer.hide(),a.controls.smallreportcontainer.hide(),a.controls.returnmenubutton.show(),a.controls.progresscontainer.hide(),a.controls.passagecontainer.removeClass("previewmode shadowmode reviewmode nothingmode"),a.controls.passagecontainer.addClass("readmode"),a.controls.passagecontainer.hide(),a.controls.feedbackcontainer.hide(),a.controls.wheretonextcontainer.hide(),a.controls.stopandplay.hide()},domenulayout:function(){var a=this;a.controls.menuinstructionscontainer.show(),a.controls.menubuttonscontainer.show(),a.controls.smallreportcontainer.show(),a.controls.activityinstructionscontainer.hide(),a.controls.returnmenubutton.hide(),a.controls.progresscontainer.hide(),a.controls.passagecontainer.hide(),a.controls.recordingcontainer.hide(),a.controls.feedbackcontainer.hide(),a.controls.wheretonextcontainer.hide(),a.controls.modelaudioplayer.hide(),a.controls.hider.hide(),a.controls.stopandplay.hide()},dopreviewlayout:function(){var a=this;a.controls.passagecontainer.removeClass("readmode shadowmode reviewmode nothingmode"),a.controls.passagecontainer.addClass("previewmode"),a.controls.passagecontainer.show(),a.controls.returnmenubutton.show(),a.controls.modelaudioplayer.hide(),a.controls.smallreportcontainer.hide(),a.controls.stopandplay.show(),a.controls.menubuttonscontainer.hide(),a.controls.hider.hide(),a.controls.progresscontainer.hide(),a.controls.menuinstructionscontainer.hide(),a.controls.activityinstructionscontainer.hide(),a.controls.recordingcontainer.hide(),a.controls.feedbackcontainer.hide(),a.controls.wheretonextcontainer.hide(),a.controls.stopandplay.show()},dopassagelayout:function(){var a=this;a.controls.introbox.hide()},douploadlayout:function(){var a=this;a.controls.passagecontainer.addClass(a.passagefinished),a.controls.hider.fadeIn("fast"),a.controls.progresscontainer.fadeIn("fast")},dofinishedlayout:function(){var a=this;a.controls.hider.fadeOut("fast"),a.controls.progresscontainer.fadeOut("fast"),a.controls.smallreportcontainer.hide(),a.controls.activityinstructionscontainer.hide(),a.controls.passagecontainer.hide(),a.controls.recordingcontainer.hide(),a.controls.feedbackcontainer.show(),a.controls.wheretonextcontainer.show(),a.controls.returnmenubutton.hide()},doerrorlayout:function(){var a=this;a.controls.hider.fadeOut("fast"),a.controls.progresscontainer.fadeOut("fast"),a.controls.passagecontainer.hide(),a.controls.recordingcontainer.hide(),a.controls.errorcontainer.show(),a.controls.wheretonextcontainer.show()}}});