define("mod_readaloud/activitycontroller",["jquery","core/log","core/str","mod_readaloud/definitions","mod_readaloud/recorderhelper","mod_readaloud/modelaudiokaraoke","core/ajax","core/notification","mod_readaloud/smallreporthelper","mod_readaloud/listenandrepeat","mod_readaloud/quizhelper","mod_readaloud/clicktohear"],(function($,log,str,def,recorderhelper,modelaudiokaraoke,Ajax,notification,smallreporthelper,landr,quizhelper,clicktohear){function disableClick(e){e.preventDefault(),e.stopImmediatePropagation()}return log.debug("Activity controller: initialising"),{cmid:null,activitydata:null,holderid:null,recorderid:null,playerid:null,sorryboxid:null,controls:null,ra_recorder:null,rec_time_start:0,steps_enabled:{},steps_open:{},steps_complete:{},letsshadow:!1,strings:{},passagefinished:def.passagefinished,clone:function(){return $.extend(!0,{},this)},init:function(props){var dd=this.clone(),theid="#amdopts_"+props.widgetid,configcontrol=$(theid).get(0);configcontrol?(dd.activitydata=JSON.parse(configcontrol.value),$(theid).remove(),dd.cmid=props.cmid,dd.holderid=props.widgetid+"_holder",dd.recorderid=props.widgetid+"_recorder",dd.playerid=props.widgetid+"_player",dd.sorryboxid=props.widgetid+"_sorrybox",dd.is_browser_ok()?(dd.steps_enabled=dd.activitydata.stepsenabled,dd.steps_open=dd.activitydata.stepsopen,dd.steps_complete=dd.activitydata.stepscomplete,dd.setupmodelaudio(),dd.setuplandr(),dd.setup_recorder(),dd.process_html(dd.activitydata),dd.register_events(),dd.setup_strings(),dd.setupquiz(),dd.setupclicktohear(),smallreporthelper.init(dd.activitydata),dd.stepshadow_enabled||dd.steplisten_enabled,dd.domenulayout()):$("#"+dd.sorryboxid).show()):log.debug("Read Aloud Test Controller: No config found on page. Giving up.")},setup_strings:function(){var dd=this;str.get_strings([{key:"confirm_cancel_recording",component:def.component},{key:"confirm_read_again",component:def.component}]).done((function(s){var i=0;dd.strings.confirm_cancel_recording=s[i++],dd.strings.confirm_read_again=s[i++]}))},setupmodelaudio:function(){var karaoke_opts={breaks:this.activitydata.breaks,audioplayerclass:this.activitydata.audioplayerclass};modelaudiokaraoke.init(karaoke_opts)},setuplandr:function(){var dd=this,landr_opts={modelaudiokaraoke:modelaudiokaraoke,cmid:this.cmid,language:this.activitydata.language,region:this.activitydata.region,phonetics:this.activitydata.phonetics,stt_guided:this.activitydata.stt_guided};landr.init(landr_opts),landr.on_complete=function(){dd.update_activity_step(dd.activitydata.steps.step_practice)}},setupclicktohear:function(){var clicktohear_opts={token:this.activitydata.token,ttsvoice:this.activitydata.ttsvoice,region:this.activitydata.region,owner:this.activitydata.owner};clicktohear.init(clicktohear_opts)},setupquiz:function(){var dd=this;dd.attemptid=1,quizhelper.init(dd.activitydata,dd.cmid,dd.attemptid),quizhelper.on_complete=function(){dd.update_activity_step(dd.activitydata.steps.step_quiz)}},process_html:function(opts){var controls={hider:$("."+opts.hider),introbox:$(".mod_intro_box"),progresscontainer:$("."+opts.progresscontainer),feedbackcontainer:$("."+opts.feedbackcontainer),errorcontainer:$("."+opts.errorcontainer),passagecontainer:$(".mod_readaloud_readingcontainer ."+opts.passagecontainer),reviewpassagecontainer:$(".mod_readaloud_studentreportpassage ."+opts.passagecontainer),recordingcontainer:$("."+opts.recordingcontainer),dummyrecorder:$("."+opts.dummyrecorder),recordercontainer:$("."+opts.recordercontainer),menubuttonscontainer:$("."+opts.menubuttonscontainer),menuinstructionscontainer:$("."+opts.menuinstructionscontainer),previewinstructionscontainer:$("."+opts.previewinstructionscontainer),landrinstructionscontainer:$("."+opts.landrinstructionscontainer),activityinstructionscontainer:$("."+opts.activityinstructionscontainer),recinstructionscontainerright:$("."+opts.recinstructionscontainerright),recinstructionscontainerleft:$("."+opts.recinstructionscontainerleft),allowearlyexit:$("."+opts.allowearlyexit),wheretonextcontainer:$("."+opts.wheretonextcontainer),modelaudioplayer:$("#"+opts.modelaudioplayer),homebutton:$("#"+opts.homebutton),startlistenbutton:$("#"+opts.menubuttonscontainer+' .mode-chooser[data-step="'+opts.steps.step_listen+'"]'),startpracticebutton:$("#"+opts.menubuttonscontainer+' .mode-chooser[data-step="'+opts.steps.step_practice+'"]'),startreadbutton:$("#"+opts.menubuttonscontainer+' .mode-chooser[data-step="'+opts.steps.step_read+'"]'),startshadowbutton:$("#"+opts.menubuttonscontainer+' .mode-chooser[data-step="'+opts.steps.step_shadow+'"]'),startquizbutton:$("#"+opts.menubuttonscontainer+' .mode-chooser[data-step="'+opts.steps.step_quiz+'"]'),readagainbutton:$("#"+opts.readagainbutton),startreportbutton:$("#"+opts.startreportbutton),returnmenubutton:$("#"+opts.returnmenubutton),stopandplay:$("#"+opts.stopandplay),smallreportcontainer:$("#"+opts.smallreportcontainer),fullreportcontainer:$("#"+opts.fullreportcontainer),readingcontainer:$("#"+def.readingcontainer),modeimagecontainer:$("#"+opts.modeimagecontainer),modejourneycontainer:$("#"+opts.modejourneycontainer),quizcontainer:$("."+opts.quizcontainer),quizplaceholder:$("."+opts.quizplaceholder),quizresultscontainer:$("."+opts.quizresultscontainer),homecontainer:$("."+opts.homecontainer)};this.controls=controls},is_browser_ok:function(){return navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},reset_recorder:function(){recorderhelper.reset(),this.setup_recorder()},setup_recorder:function(){var dd=this,beginall=function(){dd.passagerecorded=!0,dd.stepshadow_enabled&&dd.letsshadow&&dd.controls.modelaudioplayer[0].play()};recorderhelper.init(dd.activitydata,(function(eventdata){dd.rec_time_start=(new Date).getTime(),dd.dopassagelayout(),dd.controls.passagecontainer.show(500,beginall),dd.controls.passagecontainer[0].scrollIntoView({behaviour:"smooth",block:"start",inline:"nearest"})}),(function(eventdata){(new Date).getTime()-dd.rec_time_start<3e3||(dd.douploadlayout(),dd.stepshadow_enabled&&dd.letsshadow&&(dd.controls.modelaudioplayer[0].currentTime=0,dd.controls.modelaudioplayer[0].pause()))}),(function(eventdata){var rectime=(new Date).getTime()-dd.rec_time_start;rectime>0&&(rectime=Math.ceil(rectime/1e3)),dd.send_submission(eventdata.mediaurl,rectime),dd.update_activity_step(dd.activitydata.steps.step_read),smallreporthelper.update_filename(eventdata.mediaurl),smallreporthelper.start_check_for_results(),dd.doreportlayout()}),(function(eventdata){eventdata.capturedspeech,eventdata.speechresults}))},register_events:function(){var dd=this;$(".mode-chooser.no-click").each((function(){this.addEventListener("click",disableClick,!0),this.addEventListener("keypress",disableClick,!0)})),dd.controls.startlistenbutton.click((function(e){dd.dopreviewlayout(),dd.update_activity_step(dd.activitydata.steps.step_listen)})),dd.controls.startlistenbutton.keypress((function(e){32!=e.which&&13!=e.which||(dd.dopreviewlayout(),e.preventDefault(),dd.update_activity_step(dd.activitydata.steps.step_listen))})),dd.controls.startpracticebutton.click((function(e){dd.dolandrlayout()})),dd.controls.startpracticebutton.keypress((function(e){32!=e.which&&13!=e.which||(dd.dolandrlayout(),e.preventDefault())})),dd.controls.startreadbutton.click((function(e){dd.steps_complete.step_read?dd.doreportlayout():(dd.letsshadow=!1,dd.doreadinglayout())})),dd.controls.startreadbutton.keypress((function(e){32!=e.which&&13!=e.which||(dd.steps_complete.step_read?dd.doreportlayout():(dd.letsshadow=!1,dd.doreadinglayout()),e.preventDefault())})),dd.controls.readagainbutton.click((function(e){confirm(dd.strings.confirm_read_again)&&(dd.reset_recorder(),dd.letsshadow=!1,dd.doreadinglayout())})),dd.controls.readagainbutton.keypress((function(e){32!=e.which&&13!=e.which||(dd.letsshadow=!1,dd.doreadinglayout(),e.preventDefault())})),dd.controls.startshadowbutton.click((function(e){dd.letsshadow=!0,dd.doreadinglayout()})),dd.controls.startshadowbutton.keypress((function(e){32!=e.which&&13!=e.which||(dd.letsshadow=!0,dd.doreadinglayout(),e.preventDefault())})),dd.controls.returnmenubutton.click((function(e){if(dd.isandroid()&&dd.controls.landrinstructionscontainer.is(":visible"))location.reload();else if(dd.controls.readingcontainer.is(":visible")&&dd.controls.passagecontainer.hasClass("readmode")&&dd.controls.passagecontainer.is(":visible")){confirm(dd.strings.confirm_cancel_recording)&&location.reload()}else dd.controls.modelaudioplayer[0].currentTime=0,dd.controls.modelaudioplayer[0].pause(),dd.domenulayout()})),dd.controls.startreportbutton.click((function(e){dd.doreportlayout()})),dd.controls.startreportbutton.keypress((function(e){32!=e.which&&13!=e.which||dd.doreportlayout()})),dd.controls.startquizbutton.click((function(e){dd.doquizlayout()})),dd.controls.startquizbutton.keypress((function(e){32!=e.which&&13!=e.which||(dd.doquizlayout(),e.preventDefault())})),dd.controls.homebutton.click((function(e){dd.domenulayout()}))},update_activity_step:function(step){var that=this;Ajax.call([{methodname:"mod_readaloud_report_activitystep_completion",args:{cmid:that.cmid,step:step},done:function(ajaxresult){if(!0===JSON.parse(ajaxresult)){var adata=that.activitydata;for(var key in adata.steps){adata.steps[key]===step&&(that.activitydata.stepscomplete[key]=!0)}that.updateModeStatuses(),that.updateBigButtonMenuModeStatus(),that.open_next_step(step)}else log.debug("step "+step+" update failed")},fail:notification.exception}])},open_next_step:function(oldstep){var adata=this.activitydata;for(var key in adata.steps){var thestep=adata.steps[key];if(!(thestep<=oldstep)){var step_chooser=$("#"+adata.menubuttonscontainer+' .mode-chooser[data-step="'+thestep+'"]');if(log.debug(step_chooser),step_chooser.length){step_chooser.removeClass("no-click"),step_chooser[0].removeEventListener("click",disableClick,!0),oldstep==adata.steps.step_read&&this.controls.startreportbutton.removeClass("no-click");break}}}},send_submission:function(filename,rectime){var shadowing=this.stepshadow_enabled&&this.letsshadow?1:0;Ajax.call([{methodname:"mod_readaloud_submit_regular_attempt",args:{cmid:this.cmid,filename:filename,rectime:rectime,shadowing:shadowing},done:function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);if(payloadobject)if(!0===payloadobject.success)log.debug("attempted submission accepted");else log.debug("attempted item evaluation failure"),payloadobject.message&&log.debug("message: "+payloadobject.message)},fail:notification.exception}])},domenulayout:function(){var m=this;m.controls.activityinstructionscontainer.hide(),m.controls.feedbackcontainer.hide(),m.controls.hider.hide(),m.controls.landrinstructionscontainer.hide(),landr.deactivate(),m.controls.modelaudioplayer.hide(),m.controls.previewinstructionscontainer.hide(),m.controls.progresscontainer.hide(),m.controls.passagecontainer.hide(),m.controls.quizcontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.returnmenubutton.hide(),m.controls.smallreportcontainer.hide(),m.controls.wheretonextcontainer.hide(),m.controls.homecontainer.show(),m.controls.introbox.show(),m.controls.menuinstructionscontainer.show(),m.controls.menubuttonscontainer.show(),m.controls.stopandplay.removeClass("visible").addClass("hidden"),m.controls.readingcontainer.removeClass(def.containerfillscreen),m.controls.modeimagecontainer.removeClass("d-block"),m.controls.modeimagecontainer.addClass("d-none"),modelaudiokaraoke.modeling=!0,m.updateModeStatuses()},doreadinglayout:function(){var m=this;m.controls.feedbackcontainer.hide(),m.controls.homecontainer.hide(),m.controls.introbox.hide(),m.controls.menuinstructionscontainer.hide(),m.controls.menubuttonscontainer.hide(),m.controls.passagecontainer.hide(),m.controls.progresscontainer.hide(),m.controls.quizcontainer.hide(),m.controls.smallreportcontainer.hide(),m.controls.wheretonextcontainer.hide(),m.controls.passagecontainer.removeClass(m.passagefinished),m.controls.recordingcontainer.show(),m.controls.returnmenubutton.show(),m.controls.hider.fadeOut("fast"),m.controls.activityinstructionscontainer.show(),m.controls.passagecontainer.removeClass("previewmode shadowmode reviewmode nothingmode"),m.controls.passagecontainer.addClass("readmode"),m.controls.stopandplay.removeClass("visible").addClass("hidden"),m.controls.modeimagecontainer.removeClass("fa-comment fa-comments fa-headphones fa-circle-question fa-chart-simple"),m.controls.modeimagecontainer.addClass("fa-book-open-reader d-block"),modelaudiokaraoke.modeling=!0},dopreviewlayout:function(){var m=this;m.controls.activityinstructionscontainer.hide(),m.controls.feedbackcontainer.hide(),m.controls.hider.hide(),m.controls.homecontainer.hide(),m.controls.introbox.hide(),m.controls.landrinstructionscontainer.hide(),m.controls.menuinstructionscontainer.hide(),m.controls.modelaudioplayer.hide(),m.controls.progresscontainer.hide(),m.controls.quizcontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.smallreportcontainer.hide(),m.controls.stopandplay.show(),m.controls.wheretonextcontainer.hide(),m.controls.menubuttonscontainer.show(),m.controls.passagecontainer.show(),m.controls.previewinstructionscontainer.show(),m.controls.returnmenubutton.show(),m.controls.passagecontainer.removeClass("readmode shadowmode reviewmode nothingmode"),m.controls.passagecontainer.addClass("previewmode"),m.controls.stopandplay.removeClass("hidden").addClass("visible"),m.controls.modeimagecontainer.removeClass("fa-comment fa-comments fa-book-open-reader fa-circle-question fa-chart-simple"),m.controls.modeimagecontainer.addClass("fa-headphones d-block"),modelaudiokaraoke.modeling=!1},dolandrlayout:function(){var m=this;m.controls.activityinstructionscontainer.hide(),m.controls.feedbackcontainer.hide(),m.controls.homecontainer.hide(),m.controls.hider.hide(),m.controls.introbox.hide(),m.controls.modelaudioplayer.hide(),m.controls.previewinstructionscontainer.hide(),m.controls.progresscontainer.hide(),m.controls.quizcontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.smallreportcontainer.hide(),m.controls.wheretonextcontainer.hide(),m.controls.returnmenubutton.show(),m.controls.menubuttonscontainer.show(),m.controls.landrinstructionscontainer.show(),m.controls.passagecontainer.show(),m.controls.passagecontainer.removeClass("readmode shadowmode reviewmode nothingmode"),m.controls.passagecontainer.addClass("previewmode"),m.controls.stopandplay.removeClass("hidden").addClass("visible"),m.controls.modeimagecontainer.removeClass("fa-headphones fa-comments fa-book-open-reader fa-circle-question fa-chart-simple"),m.controls.modeimagecontainer.addClass("fa-comment d-block"),landr.activate(),modelaudiokaraoke.modeling=!1},dopassagelayout:function(){this.controls.introbox.hide(),this.controls.readingcontainer.addClass(def.containerfillscreen)},douploadlayout:function(){var m=this;m.controls.passagecontainer.addClass(m.passagefinished),m.controls.hider.fadeIn("fast"),m.controls.progresscontainer.fadeIn("fast")},dofinishedlayout:function(){var m=this;m.controls.activityinstructionscontainer.hide(),m.controls.passagecontainer.hide(),m.controls.quizcontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.returnmenubutton.hide(),m.controls.smallreportcontainer.hide(),m.controls.menubuttonscontainer.show(),m.controls.feedbackcontainer.show(),m.controls.wheretonextcontainer.show(),m.controls.readingcontainer.removeClass(def.containerfillscreen),m.controls.hider.fadeOut("fast"),m.controls.progresscontainer.fadeOut("fast")},doerrorlayout:function(){var m=this;m.controls.passagecontainer.hide(),m.controls.quizcontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.menubuttonscontainer.show(),m.controls.errorcontainer.show(),m.controls.wheretonextcontainer.show(),m.controls.readingcontainer.removeClass(def.containerfillscreen),m.controls.hider.fadeOut("fast"),m.controls.progresscontainer.fadeOut("fast")},doreportlayout:function(){var m=this;m.controls.activityinstructionscontainer.hide(),m.controls.homecontainer.hide(),m.controls.landrinstructionscontainer.hide(),m.controls.passagecontainer.hide(),m.controls.previewinstructionscontainer.hide(),m.controls.menuinstructionscontainer.hide(),m.controls.quizcontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.stopandplay.removeClass("visible").addClass("hidden"),m.controls.readingcontainer.removeClass(def.containerfillscreen),m.controls.hider.fadeOut("fast"),m.controls.progresscontainer.fadeOut("fast"),m.controls.menubuttonscontainer.show(),m.controls.returnmenubutton.show(),m.controls.smallreportcontainer.show(),m.controls.modeimagecontainer.removeClass("fa-headphones fa-comment fa-comments fa-book-open-reader fa-circle-question"),m.controls.modeimagecontainer.addClass("fa-chart-simple d-block")},doquizlayout:function(){var m=this;m.controls.activityinstructionscontainer.hide(),m.controls.homecontainer.hide(),m.controls.landrinstructionscontainer.hide(),m.controls.menubuttonscontainer.hide(),m.controls.passagecontainer.hide(),m.controls.previewinstructionscontainer.hide(),m.controls.quizplaceholder.hide(),m.controls.recordingcontainer.hide(),m.controls.smallreportcontainer.hide(),m.controls.quizcontainer.show(),m.controls.stopandplay.removeClass("visible").addClass("hidden"),m.controls.modeimagecontainer.removeClass("fa-headphones fa-comment fa-comments fa-book-open-reader fa-chart-simple"),m.controls.modeimagecontainer.addClass("fa-circle-question d-block")},updateModeStatuses:function(){var stepsOrder=["step_listen","step_practice","step_shadow","step_read","step_quiz","step_report"],stepsComplete=this.activitydata.stepscomplete||{},$container=this.controls.modejourneycontainer;if($container&&$container.length){var foundIncomplete=!1;$container.find(".mode").each((function(index,modeElem){var $mode=$(modeElem),stepName=stepsOrder[index];$mode.removeClass("completed in-progress upcoming"),!0===stepsComplete[stepName]||"true"===stepsComplete[stepName]?$mode.addClass("completed"):foundIncomplete?$mode.addClass("upcoming"):($mode.addClass("in-progress"),foundIncomplete=!0)}))}else console.error("Mode journey container not found.")},updateBigButtonMenuModeStatus:function(){var stepsOrder=["step_listen","step_practice","step_shadow","step_read","step_quiz","step_report"],stepsComplete=this.activitydata.stepscomplete||{},thecontainer=this.controls.menubuttonscontainer;if(thecontainer&&thecontainer.length){var foundIncomplete=!1;thecontainer.find("li.mode-chooser").each((function(index,liElem){var status,$li=$(liElem),stepName=stepsOrder[index];!0===stepsComplete[stepName]||"true"===stepsComplete[stepName]?status="completed":foundIncomplete?status="upcoming":(status="in-progress",foundIncomplete=!0);var $iconSpan=$li.find(".nav-completion-icon");$iconSpan.length&&("completed"===status?$iconSpan.html('<i class="fa-solid fa-circle-check text-success" title="Complete"></i>'):"in-progress"===status?$iconSpan.html('<i class="fa-regular fa-circle text-warning" title="In progress"></i>'):$iconSpan.html('<i class="fa-solid fa-lock text-secondary" title="Locked"></i>'))}))}else console.error("Menu buttons container not found.")},isandroid:function(){return!!/Android/i.test(navigator.userAgent)}}}));

//# sourceMappingURL=activitycontroller.min.js.map