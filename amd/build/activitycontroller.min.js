define("mod_readaloud/activitycontroller",["jquery","core/log","core/str","mod_readaloud/definitions","mod_readaloud/recorderhelper","mod_readaloud/modelaudiokaraoke","core/ajax","core/notification","mod_readaloud/smallreporthelper","mod_readaloud/listenandrepeat","mod_readaloud/quizhelper"],(function($,log,str,def,recorderhelper,modelaudiokaraoke,Ajax,notification,smallreporthelper,landr,quizhelper){return log.debug("Activity controller: initialising"),{cmid:null,activitydata:null,holderid:null,recorderid:null,playerid:null,sorryboxid:null,controls:null,ra_recorder:null,rec_time_start:0,enableshadow:!1,enablepreview:!1,enablelandr:!1,letsshadow:!1,strings:{},passagefinished:def.passagefinished,clone:function(){return $.extend(!0,{},this)},init:function(props){var dd=this.clone(),theid="#amdopts_"+props.widgetid,configcontrol=$(theid).get(0);configcontrol?(dd.activitydata=JSON.parse(configcontrol.value),$(theid).remove(),dd.cmid=props.cmid,dd.holderid=props.widgetid+"_holder",dd.recorderid=props.widgetid+"_recorder",dd.playerid=props.widgetid+"_player",dd.sorryboxid=props.widgetid+"_sorrybox",dd.is_browser_ok()?(dd.enableshadow=dd.activitydata.enableshadow,dd.enablepreview=dd.activitydata.enablepreview,dd.enablelandr=dd.activitydata.enablelandr,dd.setupmodelaudio(),dd.setuplandr(),dd.setup_recorder(),dd.process_html(dd.activitydata),dd.register_events(),dd.setup_strings(),dd.setupquiz(),dd.enableshadow||dd.enablepreview,dd.domenulayout()):$("#"+dd.sorryboxid).show()):log.debug("Read Aloud Test Controller: No config found on page. Giving up.")},setup_strings:function(){var dd=this;str.get_strings([{key:"confirm_cancel_recording",component:def.component}]).done((function(s){var i=0;dd.strings.confirm_cancel_recording=s[i++]}))},setupmodelaudio:function(){var karaoke_opts={breaks:this.activitydata.breaks,audioplayerclass:this.activitydata.audioplayerclass};modelaudiokaraoke.init(karaoke_opts)},setuplandr:function(){var landr_opts={modelaudiokaraoke:modelaudiokaraoke,cmid:this.cmid,language:this.activitydata.language,region:this.activitydata.region,phonetics:this.activitydata.phonetics,stt_guided:this.activitydata.stt_guided};landr.init(landr_opts)},setupquiz:function(){this.attemptid=1,quizhelper.init(this.activitydata,this.cmid,this.attemptid)},process_html:function(opts){var controls={hider:$("."+opts.hider),introbox:$(".mod_intro_box"),progresscontainer:$("."+opts.progresscontainer),feedbackcontainer:$("."+opts.feedbackcontainer),errorcontainer:$("."+opts.errorcontainer),passagecontainer:$("."+opts.passagecontainer),recordingcontainer:$("."+opts.recordingcontainer),dummyrecorder:$("."+opts.dummyrecorder),recordercontainer:$("."+opts.recordercontainer),menubuttonscontainer:$("."+opts.menubuttonscontainer),menuinstructionscontainer:$("."+opts.menuinstructionscontainer),previewinstructionscontainer:$("."+opts.previewinstructionscontainer),landrinstructionscontainer:$("."+opts.landrinstructionscontainer),activityinstructionscontainer:$("."+opts.activityinstructionscontainer),recinstructionscontainerright:$("."+opts.recinstructionscontainerright),recinstructionscontainerleft:$("."+opts.recinstructionscontainerleft),allowearlyexit:$("."+opts.allowearlyexit),wheretonextcontainer:$("."+opts.wheretonextcontainer),modelaudioplayer:$("#"+opts.modelaudioplayer),startlandrbutton:$("#"+opts.startlandrbutton),homebutton:$("#"+opts.homebutton),startpreviewbutton:$("#"+opts.startpreviewbutton),startreadingbutton:$("#"+opts.startreadingbutton),startreportbutton:$("#"+opts.startreportbutton),startshadowbutton:$("#"+opts.startshadowbutton),startquizbutton:$("#"+opts.startquizbutton),returnmenubutton:$("#"+opts.returnmenubutton),stopandplay:$("#"+opts.stopandplay),smallreportcontainer:$("#"+opts.smallreportcontainer),readingcontainer:$("#"+def.readingcontainer),modeimagecontainer:$("#"+opts.modeimagecontainer),quizcontainer:$("."+opts.quizcontainer),quizplaceholder:$("."+opts.quizplaceholder),quizresultscontainer:$("."+opts.quizresultscontainer),homecontainer:$("."+opts.homecontainer)};this.controls=controls},is_browser_ok:function(){return navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},setup_recorder:function(){var dd=this,beginall=function(){dd.passagerecorded=!0,dd.enableshadow&&dd.letsshadow&&dd.controls.modelaudioplayer[0].play()};recorderhelper.init(dd.activitydata,(function(eventdata){dd.rec_time_start=(new Date).getTime(),dd.dopassagelayout(),dd.controls.passagecontainer.show(500,beginall),dd.controls.passagecontainer[0].scrollIntoView({behaviour:"smooth",block:"start",inline:"nearest"})}),(function(eventdata){(new Date).getTime()-dd.rec_time_start<3e3||(dd.douploadlayout(),dd.enableshadow&&dd.letsshadow&&(dd.controls.modelaudioplayer[0].currentTime=0,dd.controls.modelaudioplayer[0].pause()))}),(function(eventdata){var rectime=(new Date).getTime()-dd.rec_time_start;rectime>0&&(rectime=Math.ceil(rectime/1e3)),dd.send_submission(eventdata.mediaurl,rectime),dd.dofinishedlayout()}),(function(eventdata){eventdata.capturedspeech,eventdata.speechresults}))},register_events:function(){var dd=this;dd.controls.startpreviewbutton.click((function(e){dd.dopreviewlayout()})),dd.controls.startpreviewbutton.keypress((function(e){32!=e.which&&13!=e.which||(dd.dopreviewlayout(),e.preventDefault())})),dd.controls.startlandrbutton.click((function(e){dd.dolandrlayout()})),dd.controls.startlandrbutton.keypress((function(e){32!=e.which&&13!=e.which||(dd.dolandrlayout(),e.preventDefault())})),dd.controls.startreadingbutton.click((function(e){dd.letsshadow=!1,dd.doreadinglayout()})),dd.controls.startreadingbutton.keypress((function(e){32!=e.which&&13!=e.which||(dd.letsshadow=!1,dd.doreadinglayout(),e.preventDefault())})),dd.controls.startshadowbutton.click((function(e){dd.letsshadow=!0,dd.doreadinglayout()})),dd.controls.startshadowbutton.keypress((function(e){32!=e.which&&13!=e.which||(dd.letsshadow=!0,dd.doreadinglayout(),e.preventDefault())})),dd.controls.returnmenubutton.click((function(e){if(dd.isandroid()&&dd.controls.landrinstructionscontainer.is(":visible"))location.reload();else if(dd.controls.readingcontainer.is(":visible")&&dd.controls.passagecontainer.hasClass("readmode")&&dd.controls.passagecontainer.is(":visible")){confirm(dd.strings.confirm_cancel_recording)&&location.reload()}else dd.controls.modelaudioplayer[0].currentTime=0,dd.controls.modelaudioplayer[0].pause(),dd.domenulayout()})),dd.controls.startreportbutton.click((function(e){dd.doreportlayout()})),dd.controls.startquizbutton.click((function(e){dd.doquizlayout()})),dd.controls.startquizbutton.keypress((function(e){32!=e.which&&13!=e.which||(dd.doquizlayout(),e.preventDefault())})),dd.controls.homebutton.click((function(e){dd.domenulayout()}))},send_submission:function(filename,rectime){var shadowing=this.enableshadow&&this.letsshadow?1:0;Ajax.call([{methodname:"mod_readaloud_submit_regular_attempt",args:{cmid:this.cmid,filename:filename,rectime:rectime,shadowing:shadowing},done:function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);if(payloadobject)if(!0===payloadobject.success)log.debug("attempted submission accepted");else log.debug("attempted item evaluation failure"),payloadobject.message&&log.debug("message: "+payloadobject.message)},fail:notification.exception}])},domenulayout:function(){var m=this;m.controls.activityinstructionscontainer.hide(),m.controls.feedbackcontainer.hide(),m.controls.hider.hide(),m.controls.landrinstructionscontainer.hide(),landr.deactivate(),m.controls.modelaudioplayer.hide(),m.controls.previewinstructionscontainer.hide(),m.controls.progresscontainer.hide(),m.controls.passagecontainer.hide(),m.controls.quizcontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.returnmenubutton.hide(),m.controls.smallreportcontainer.hide(),m.controls.wheretonextcontainer.hide(),m.controls.homecontainer.show(),m.controls.introbox.show(),m.controls.menuinstructionscontainer.show(),m.controls.stopandplay.removeClass("visible").addClass("hidden"),m.controls.readingcontainer.removeClass(def.containerfillscreen),m.controls.modeimagecontainer.removeClass("d-block"),m.controls.modeimagecontainer.addClass("d-none"),modelaudiokaraoke.modeling=!0},doreadinglayout:function(){var m=this;m.controls.feedbackcontainer.hide(),m.controls.homecontainer.hide(),m.controls.introbox.hide(),m.controls.menuinstructionscontainer.hide(),m.controls.menubuttonscontainer.hide(),m.controls.passagecontainer.hide(),m.controls.progresscontainer.hide(),m.controls.quizcontainer.hide(),m.controls.smallreportcontainer.hide(),m.controls.wheretonextcontainer.hide(),m.controls.recordingcontainer.show(),m.controls.returnmenubutton.show(),m.controls.hider.fadeOut("fast"),m.controls.activityinstructionscontainer.show(),m.controls.passagecontainer.removeClass("previewmode shadowmode reviewmode nothingmode"),m.controls.passagecontainer.addClass("readmode"),m.controls.stopandplay.removeClass("visible").addClass("hidden"),m.controls.modeimagecontainer.removeClass("fa-comment fa-comments fa-headphones fa-circle-question fa-chart-simple"),m.controls.modeimagecontainer.addClass("fa-book-open-reader d-block"),modelaudiokaraoke.modeling=!0},dopreviewlayout:function(){var m=this;m.controls.activityinstructionscontainer.hide(),m.controls.feedbackcontainer.hide(),m.controls.hider.hide(),m.controls.homecontainer.hide(),m.controls.introbox.hide(),m.controls.landrinstructionscontainer.hide(),m.controls.menuinstructionscontainer.hide(),m.controls.modelaudioplayer.hide(),m.controls.progresscontainer.hide(),m.controls.quizcontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.smallreportcontainer.hide(),m.controls.stopandplay.show(),m.controls.wheretonextcontainer.hide(),m.controls.passagecontainer.show(),m.controls.previewinstructionscontainer.show(),m.controls.returnmenubutton.show(),m.controls.passagecontainer.removeClass("readmode shadowmode reviewmode nothingmode"),m.controls.passagecontainer.addClass("previewmode"),m.controls.stopandplay.removeClass("hidden").addClass("visible"),m.controls.modeimagecontainer.removeClass("fa-comment fa-comments fa-book-open-reader fa-circle-question fa-chart-simple"),m.controls.modeimagecontainer.addClass("fa-headphones d-block"),modelaudiokaraoke.modeling=!1},dolandrlayout:function(){var m=this;m.controls.activityinstructionscontainer.hide(),m.controls.feedbackcontainer.hide(),m.controls.homecontainer.hide(),m.controls.hider.hide(),m.controls.introbox.hide(),m.controls.modelaudioplayer.hide(),m.controls.previewinstructionscontainer.hide(),m.controls.progresscontainer.hide(),m.controls.quizcontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.returnmenubutton.show(),m.controls.smallreportcontainer.hide(),m.controls.wheretonextcontainer.hide(),m.controls.landrinstructionscontainer.show(),m.controls.passagecontainer.show(),m.controls.passagecontainer.removeClass("readmode shadowmode reviewmode nothingmode"),m.controls.passagecontainer.addClass("previewmode"),m.controls.stopandplay.removeClass("hidden").addClass("visible"),m.controls.modeimagecontainer.removeClass("fa-headphones fa-comments fa-book-open-reader fa-circle-question fa-chart-simple"),m.controls.modeimagecontainer.addClass("fa-comment d-block"),landr.activate(),modelaudiokaraoke.modeling=!1},dopassagelayout:function(){this.controls.introbox.hide(),this.controls.readingcontainer.addClass(def.containerfillscreen)},douploadlayout:function(){var m=this;m.controls.passagecontainer.addClass(m.passagefinished),m.controls.hider.fadeIn("fast"),m.controls.progresscontainer.fadeIn("fast")},dofinishedlayout:function(){var m=this;m.controls.activityinstructionscontainer.hide(),m.controls.passagecontainer.hide(),m.controls.quizcontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.returnmenubutton.hide(),m.controls.smallreportcontainer.hide(),m.controls.feedbackcontainer.show(),m.controls.wheretonextcontainer.show(),m.controls.readingcontainer.removeClass(def.containerfillscreen),m.controls.hider.fadeOut("fast"),m.controls.progresscontainer.fadeOut("fast")},doerrorlayout:function(){var m=this;m.controls.passagecontainer.hide(),m.controls.quizcontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.errorcontainer.show(),m.controls.wheretonextcontainer.show(),m.controls.readingcontainer.removeClass(def.containerfillscreen),m.controls.hider.fadeOut("fast"),m.controls.progresscontainer.fadeOut("fast")},doreportlayout:function(){var m=this;m.controls.activityinstructionscontainer.hide(),m.controls.homecontainer.hide(),m.controls.landrinstructionscontainer.hide(),m.controls.passagecontainer.hide(),m.controls.previewinstructionscontainer.hide(),m.controls.quizcontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.returnmenubutton.show(),m.controls.smallreportcontainer.show(),m.controls.modeimagecontainer.removeClass("fa-headphones fa-comment fa-comments fa-book-open-reader fa-circle-question"),m.controls.modeimagecontainer.addClass("fa-chart-simple d-block")},doquizlayout:function(){var m=this;m.controls.activityinstructionscontainer.hide(),m.controls.homecontainer.hide(),m.controls.landrinstructionscontainer.hide(),m.controls.menubuttonscontainer.hide(),m.controls.passagecontainer.hide(),m.controls.previewinstructionscontainer.hide(),m.controls.quizplaceholder.hide(),m.controls.recordingcontainer.hide(),m.controls.smallreportcontainer.hide(),m.controls.quizcontainer.show(),m.controls.stopandplay.removeClass("visible").addClass("hidden"),m.controls.modeimagecontainer.removeClass("fa-headphones fa-comment fa-comments fa-book-open-reader fa-chart-simple"),m.controls.modeimagecontainer.addClass("fa-circle-question d-block")},isandroid:function(){return!!/Android/i.test(navigator.userAgent)}}}));

//# sourceMappingURL=activitycontroller.min.js.map