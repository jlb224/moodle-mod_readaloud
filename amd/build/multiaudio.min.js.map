{"version":3,"file":"multiaudio.min.js","sources":["../src/multiaudio.js"],"sourcesContent":["define(['jquery',\r\n    'core/log',\r\n    'mod_readaloud/definitions',\r\n    'mod_readaloud/pollyhelper',\r\n    'mod_readaloud/cloudpoodllloader',\r\n    'mod_readaloud/ttrecorder',\r\n    'mod_readaloud/animatecss'\r\n    ], function($, log, def, polly,cloudpoodll, ttrecorder,anim) {\r\n  \"use strict\"; // jshint ;_;\r\n\r\n  /*\r\n  This file is to manage the quiz stage\r\n   */\r\n\r\n  log.debug('Readaloud Multiaudio: initialising');\r\n\r\n  return {\r\n\r\n      //a handle on the tt recorder\r\n      ttrec: null,\r\n\r\n      passmark: 90,//lower this if it often doesnt match (was 85)\r\n      playing: false,\r\n\r\n    //for making multiple instances\r\n      clone: function () {\r\n          return $.extend(true, {}, this);\r\n     },\r\n\r\n    init: function(index, itemdata, quizhelper) {\r\n\r\n      //anim\r\n      var animopts = {};\r\n        animopts.useanimatecss=quizhelper.useanimatecss;\r\n      anim.init(animopts);\r\n\r\n      this.prepare_audio(itemdata);\r\n      this.register_events(index, itemdata, quizhelper);\r\n      this.init_components(index, itemdata, quizhelper);\r\n    },\r\n    next_question: function(percent) {\r\n      var self = this;\r\n      var stepdata = {};\r\n      stepdata.index = self.index;\r\n      stepdata.hasgrade = true;\r\n      stepdata.totalitems = 1;\r\n      stepdata.correctitems = percent>0?1:0;\r\n      stepdata.grade = percent;\r\n      self.quizhelper.do_next(stepdata);\r\n    },\r\n    register_events: function(index, itemdata, quizhelper) {\r\n      \r\n      var self = this;\r\n      var theplayer = $(\"#\" + itemdata.uniqueid + \"_player\");\r\n      self.index = index;\r\n      self.quizhelper = quizhelper;\r\n      \r\n      $(\"#\" + itemdata.uniqueid + \"_container .readaloud_nextbutton\").on('click', function(e) {\r\n        self.next_question(0);\r\n      });\r\n      \r\n      $(\"#\" + itemdata.uniqueid + \"_container .mcplayrow\").on('click', function(e) {\r\n        //if disabled =>just return (already answered)\r\n          if($(\"#\" + itemdata.uniqueid + \"_container .mcplayrow\").hasClass('readaloud_mc_disabled')){\r\n            return;\r\n          }\r\n\r\n          //audio play requests\r\n          if (!self.playing) {\r\n              var el = this;\r\n              self.playing = true;\r\n              theplayer.attr('src', $(this).attr('data-src'));\r\n              theplayer[0].play();\r\n              theplayer[0].onended = function() {\r\n                  $(el).find(\".readaloud_mc_playstate\").removeClass(\"fa-spin fa-spinner\").addClass(\"fa-play\");\r\n                  self.playing = false;\r\n              };\r\n              $(el).find(\".readaloud_mc_playstate\").removeClass(\"fa-play\").addClass(\"fa-spin fa-spinner\");\r\n          }else{\r\n              theplayer[0].pause();\r\n              theplayer[0].currentTime=0;\r\n              $(\"#\" + itemdata.uniqueid + \"_container .readaloud_mc_playstate\").removeClass(\"fa-spin fa-spinner\").addClass(\"fa-play\");\r\n              self.playing = false;\r\n          }\r\n\r\n          //get selected item index\r\n          //var checked = $(this).data('index');\r\n\r\n      });\r\n      \r\n    },//end of register events\r\n\r\n    prepare_audio: function(itemdata) {\r\n         // debugger;\r\n          $.each(itemdata.sentences, function(index, sentence) {\r\n              polly.fetch_polly_url(sentence.sentence, itemdata.voiceoption, itemdata.usevoice).then(function(audiourl) {\r\n                  $(\"#\" + itemdata.uniqueid + \"_option\" + (index+1)).attr(\"data-src\", audiourl);\r\n              });\r\n          });\r\n    },\r\n\r\n    process_accepted_response: function(itemdata, checked){\r\n\r\n        //disable the answers, cos its answered\r\n        $(\"#\" + itemdata.uniqueid + \"_container .mcplayrow\").addClass('readaloud_mc_disabled');\r\n\r\n\r\n        //turn dots into text (if they were dots)\r\n        if(parseInt(itemdata.show_text)==0) {\r\n            for (var i = 0; i < itemdata.sentences.length; i++) {\r\n                var theline = $(\"#\" + itemdata.uniqueid + \"_option\" + (i + 1));\r\n                $(\"#\" + itemdata.uniqueid + \"_option\" + (i + 1) + ' .readaloud_sentence').text(itemdata.sentences[i].sentence);\r\n            }\r\n        }\r\n\r\n        //reveal answers\r\n        $(\"#\" + itemdata.uniqueid + \"_container .readaloud_mc_wrong\").show();\r\n        $(\"#\" + itemdata.uniqueid + \"_option\" + itemdata.correctanswer + \" .readaloud_mc_wrong\").hide();\r\n        $(\"#\" + itemdata.uniqueid + \"_option\" + itemdata.correctanswer + \" .readaloud_mc_right\").show();\r\n\r\n        //highlight selected answers\r\n        $(\"#\" + itemdata.uniqueid + \"_option\" + checked + ' .readaloud_mc_response').addClass('readaloud_mc_selected');\r\n\r\n\r\n        var percent = checked == itemdata.correctanswer ? 100 : 0;\r\n\r\n        return percent;\r\n\r\n    },\r\n\r\n    init_components: function(index, itemdata, quizhelper) {\r\n        var app= this;\r\n        var correcttext = itemdata.sentences[itemdata.correctanswer-1].sentence;\r\n        var correctphonetic = itemdata.sentences[itemdata.correctanswer-1].phonetic;\r\n        var cleanincorrecttexts=[];\r\n\r\n        log.debug('initcomponents_multiaudio');\r\n        log.debug(itemdata.sentences);\r\n\r\n        for(var i=0;i<itemdata.sentences.length;i++){\r\n            if(i+1==itemdata.correctanswer) {\r\n                //to make life simple for ourselves we add an empty string entry in incorrecttexts at the correct answer index\r\n                //NB index of item in DOM is 1 based , so we need to mess with +1's\r\n                cleanincorrecttexts[i]='';\r\n            }else{\r\n                cleanincorrecttexts[i]=quizhelper.cleanText(itemdata.sentences[i].sentence);\r\n            }\r\n        }\r\n\r\n        var cleancorrecttext = quizhelper.cleanText(correcttext);\r\n\r\n        var theCallback = function(message) {\r\n\r\n            switch (message.type) {\r\n                case 'recording':\r\n\r\n                    break;\r\n\r\n                case 'speech':\r\n                    log.debug(\"speech at multiaudio\");\r\n                    var speechtext = message.capturedspeech;\r\n                    var cleanspeechtext = quizhelper.cleanText(speechtext);\r\n                    var spoken = cleanspeechtext;\r\n                    log.debug('speechtext:',speechtext);\r\n                    log.debug('spoken:',spoken);\r\n                    log.debug('correct:',cleancorrecttext);\r\n                    //Similarity check by character matching\r\n                    var similarity = quizhelper.similarity(spoken, cleancorrecttext);\r\n                    log.debug('JS similarity: ' + spoken + ':' + cleancorrecttext + ':' + similarity);\r\n\r\n                    //Similarity check by direct-match/acceptable-mistranscription\r\n                    if (similarity >= app.passmark ||\r\n                        app.wordsDoMatch(quizhelper, cleanspeechtext, cleancorrecttext)) {\r\n                        log.debug('local correct match:' + ':' + spoken + ':' + cleancorrecttext);\r\n                        var percent = app.process_accepted_response(itemdata, itemdata.correctanswer);\r\n\r\n                        //proceed to next question\r\n                        setTimeout(function() {\r\n                            $(\".readaloud_nextbutton\").prop(\"disabled\", false);\r\n                            app.next_question(percent);\r\n                        }, 2000);\r\n\r\n                        return;\r\n                    }else{\r\n                        for(var x=0;x<cleanincorrecttexts.length;x++){\r\n                            //if this is the correct answer index, just move on\r\n                            if(cleanincorrecttexts[x]===''){continue;}\r\n                            var similar = quizhelper.similarity(spoken, cleanincorrecttexts[x]);\r\n                            log.debug('JS similarity: ' + spoken + ':' + cleanincorrecttexts[x] + ':' + similar);\r\n                            if (similar >= app.passmark ||\r\n                                app.wordsDoMatch(quizhelper, cleanspeechtext, cleanincorrecttexts[x])) {\r\n\r\n                              //proceed to next question\r\n                                var percent = app.process_accepted_response(itemdata, x+1);\r\n                                $(\".readaloud_nextbutton\").prop(\"disabled\", true);\r\n\r\n                                //proceed to next question\r\n                                setTimeout(function() {\r\n                                    $(\".readaloud_nextbutton\").prop(\"disabled\", false);\r\n                                    app.next_question(percent);\r\n                                }, 2000);\r\n                                return;\r\n                            }//end of if similarity\r\n                        }//end of for x\r\n                    }\r\n\r\n                    //Similarity check by phonetics(ajax)\r\n                    quizhelper.checkByPhonetic(cleancorrecttext,spoken, correctphonetic, itemdata.language).then(function(similarity) {\r\n                        if (similarity === false) {\r\n                            return $.Deferred().reject();\r\n                        } else {\r\n                            log.debug('PHP similarity: ' + spoken + ':' + cleancorrecttext + ':' + similarity);\r\n                            if (similarity >= app.passmark) {\r\n                                var percent = app.process_accepted_response(itemdata, itemdata.correctanswer);\r\n\r\n                                //proceed to next question\r\n                                $(\".readaloud_nextbutton\").prop(\"disabled\", true);\r\n                                setTimeout(function() {\r\n                                    $(\".readaloud_nextbutton\").prop(\"disabled\", false);\r\n                                    app.next_question(percent);\r\n                                }, 2000);\r\n                            }\r\n                        } //end of if check_by_phonetic result\r\n\r\n                        //whatever was spoken was off, so give a visual indication of that\r\n                        //shake the screen\r\n                        var therecorder = $(\"#ttrec_container_\" + itemdata.uniqueid);\r\n                        anim.do_animate(therecorder,'shakeX animate__faster').then(\r\n                            function() {}\r\n                        );\r\n\r\n                    }); //end of check by phonetic\r\n\r\n            } //end of switch message type\r\n        };\r\n\r\n\r\n\r\n        if(quizhelper.use_ttrecorder()) {\r\n            //init tt recorder\r\n            var opts = {};\r\n            opts.uniqueid = itemdata.uniqueid;\r\n            log.debug('ma uniqueid:' + itemdata.uniqueid);\r\n            opts.callback = theCallback;\r\n            opts.stt_guided=quizhelper.is_stt_guided();\r\n            app.ttrec = ttrecorder.clone();\r\n            app.ttrec.init(opts);\r\n\r\n            //prompt for TT recorder\r\n            var allsentences=\"\";\r\n            for(var i=0;i< itemdata.sentences.length; i++){\r\n                allsentences += quizhelper.cleanText(itemdata.sentences[i].sentence) + ' ';\r\n            }\r\n            app.ttrec.currentPrompt=allsentences;\r\n\r\n        }else{\r\n            //init cloudpoodll push recorder\r\n            cloudpoodll.init('readaloud-recorder-multiaudio-' + itemdata.id, theCallback);\r\n        }\r\n\r\n    }, //end of init components\r\n\r\n    wordsDoMatch: function(quizhelper, phraseheard, currentphrase) {\r\n        //lets lower case everything\r\n        phraseheard = quizhelper.cleanText(phraseheard);\r\n        currentphrase = quizhelper.cleanText(currentphrase);\r\n        if (phraseheard == currentphrase) {\r\n            return true;\r\n        }\r\n        return false;\r\n    },\r\n  };\r\n});"],"names":["define","$","log","def","polly","cloudpoodll","ttrecorder","anim","debug","ttrec","passmark","playing","clone","extend","this","init","index","itemdata","quizhelper","animopts","useanimatecss","prepare_audio","register_events","init_components","next_question","percent","stepdata","hasgrade","totalitems","correctitems","grade","do_next","self","theplayer","uniqueid","on","e","hasClass","pause","currentTime","removeClass","addClass","el","attr","play","onended","find","each","sentences","sentence","fetch_polly_url","voiceoption","usevoice","then","audiourl","process_accepted_response","checked","parseInt","show_text","i","length","text","show","correctanswer","hide","app","correcttext","correctphonetic","phonetic","cleanincorrecttexts","cleanText","cleancorrecttext","theCallback","message","type","speechtext","capturedspeech","cleanspeechtext","spoken","similarity","wordsDoMatch","setTimeout","prop","x","similar","checkByPhonetic","language","Deferred","reject","therecorder","do_animate","use_ttrecorder","opts","callback","stt_guided","is_stt_guided","allsentences","currentPrompt","id","phraseheard","currentphrase"],"mappings":"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"}