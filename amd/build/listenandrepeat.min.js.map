{"version":3,"sources":["../src/listenandrepeat.js"],"names":["define","$","log","ajax","def","cloudpoodll","debug","currentSentence","currentAudioStart","currentAudioStop","mak","controls","results","init","props","self","message","type","getComparison","capturedspeech","comparison","gotComparison","modelaudiokaraoke","prepare_controls","register_events","register_mak","activate","container","landrcontainer","hiddenplayer","playbutton","skipbutton","stopbutton","audiourl","fetch_audio_url","attr","on_reach_audio_break","sentence","oldbreak","newbreak","trim","audiotime","currentAudioEnd","pause_audio","modal","html","replace","split","map","on","currentTime","play","playing","pause","play_audio","ontimeupdate","spliton","typed","console","JSON","stringify","passage","transcript","callback","call","methodname","args","alternatives","language","done","ajaxresult","payloadobject","parse","fail","err"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'core/ajax', 'mod_readaloud/definitions', 'mod_readaloud/cloudpoodllloader'], function($, log, ajax, def, cloudpoodll) {\n  \"use strict\"; // jshint ;_;\n\n  log.debug('Readaloud listen and repeat: initialising');\n\n  return {\n\n    currentSentence:\"\",\n    currentAudioStart: 0,\n    currentAudioStop: 0,\n    mak: null,\n    controls: {},\n    results:[],\n    init: function(props) {\n      var self = this;\n      var recid ='readaloud_pushrecorder';\n\n      cloudpoodll.init(recid, function(message) {\n        switch (message.type) {\n          case 'recording':\n            break;\n\n          case 'speech':\n            self.getComparison(\n              self.currentSentence,\n              message.capturedspeech,\n              function(comparison) {\n                self.gotComparison(comparison, message);\n              }\n            );\n            break;\n\n        }\n\n      });\n      self.mak = props.modelaudiokaraoke;\n\n      self.prepare_controls();\n      self.register_events();\n      self.register_mak();\n    },\n\n    activate: function(){\n        this.results = [];\n    },\n\n    prepare_controls: function(){\n        var self = this;\n        self.controls.container =$('#' + def.landrcontainer);\n        self.controls.hiddenplayer = $('#mod_readaloud_landr_hiddenplayer');\n        self.controls.playbutton = $('#mod_readaloud_landr_modalplay');\n        self.controls.skipbutton = $('#mod_readaloud_landr_modalskip');\n        self.controls.stopbutton = $('#mod_readaloud_landr_modalstop');\n        self.audiourl = self.mak.fetch_audio_url();\n        self.controls.hiddenplayer.attr('src',self.audiourl);\n\n    },\n\n    register_mak: function() {\n      var self = this;\n      \n      self.mak.on_reach_audio_break = function(sentence, oldbreak, newbreak) {\n\n        // sentence contains the target text\n\n        //empty strings are none of our concern\n        if (sentence.trim() === '') {\n          return;\n        }\n\n        self.currentSentence = sentence;\n        self.currentAudioStart = oldbreak.audiotime;\n        self.currentAudioEnd = newbreak.audiotime;\n        \n        log.debug(sentence);\n        log.debug(oldbreak);\n        log.debug(newbreak);\n\n        //pause audio while we do our thing\n        self.mak.pause_audio();\n        self.controls.container.modal('show');\n        $(\"#mod_readaloud_modal_target_phrase\").html(sentence.replace(/[a-zA-Z0-9]/g,'').split(/ /).map(function(e){return '<span></span>';}));\n\n      }\n\n    },\n\n    register_events: function() {\n\n      var self = this;\n\n      self.controls.playbutton.on('click',function(e){\n         self.controls.hiddenplayer[0].currentTime=self.currentAudioStart;\n          self.controls.hiddenplayer[0].play();\n      });\n\n        self.controls.skipbutton.on('click',function(e){\n            self.controls.container.modal('hide');\n            if(self.controls.hiddenplayer[0].playing){\n                self.controls.hiddenplayer[0].pause();\n            }\n            self.mak.play_audio();\n        });\n\n        self.controls.stopbutton.on('click',function(e){\n            self.controls.container.modal('hide');\n            if(self.controls.hiddenplayer[0].playing){\n                self.controls.hiddenplayer[0].pause();\n            }\n        });\n\n      self.controls.hiddenplayer[0].ontimeupdate =function(){\n        if(self.controls.hiddenplayer[0].currentTime >= self.currentAudioEnd){\n            self.controls.hiddenplayer[0].pause();\n        }\n      };\n\n    },\n\n    spliton: new RegExp('([,.!?:;\" ])', 'g'),\n\n    gotComparison: function(comparison, typed) {\n\n      var self = this;\n      console.log(\"comparison:\"+JSON.stringify(comparison));\n      console.log(\"typed:\"+JSON.stringify(typed));\n      //self.results[i]=100\n\n    },\n    getComparison: function(passage, transcript, callback) {\n      var self = this;\n\n      ajax.call([{\n        methodname: 'mod_readaloud_compare_passage_to_transcript',\n        args: {\n          passage: passage,\n          transcript: transcript,\n          alternatives: '',\n          language: 'en-US'\n        },\n        done: function(ajaxresult) {\n          var payloadobject = JSON.parse(ajaxresult);\n          if (payloadobject) {\n            callback(payloadobject);\n          } else {\n            callback(false);\n          }\n        },\n        fail: function(err) {\n          console.log(err);\n        }\n      }]);\n\n    }\n\n  };\n});"],"file":"listenandrepeat.min.js"}