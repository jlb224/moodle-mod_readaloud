{"version":3,"sources":["../src/listenandrepeat.js"],"names":["define","$","log","ajax","def","cloudpoodll","debug","activated","currentSentence","currentAudioStart","currentAudioStop","mak","controls","results","init","props","self","message","type","getComparison","capturedspeech","comparison","gotComparison","modelaudiokaraoke","prepare_controls","register_events","register_mak","activate","deactivate","audioplayer","playing","pause","container","landrcontainer","hiddenplayer","playbutton","skipbutton","finishedbutton","audiourl","fetch_audio_url","attr","on_reach_audio_break","sentence","oldbreak","newbreak","breaks","trim","audiotime","currentAudioEnd","breaknumber","length","show","hide","pause_audio","modal","html","split","map","e","i","on","currentTime","play","play_audio","ontimeupdate","spliton","thisClass","removeClass","forEach","word","idx","matched","addClass","passage","transcript","callback","call","methodname","args","alternatives","language","done","ajaxresult","payloadobject","JSON","parse","fail","err","console"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'core/ajax', 'mod_readaloud/definitions', 'mod_readaloud/cloudpoodllloader'], function($, log, ajax, def, cloudpoodll) {\n  \"use strict\"; // jshint ;_;\n\n  log.debug('Readaloud listen and repeat: initialising');\n\n  return {\n\n    activated: false,\n    currentSentence: \"\",\n    currentAudioStart: 0,\n    currentAudioStop: 0,\n    mak: null,\n    controls: {},\n    results: [],\n    init: function(props) {\n      var self = this;\n      var recid = 'readaloud_pushrecorder';\n\n      cloudpoodll.init(recid, function(message) {\n        switch (message.type) {\n          case 'recording':\n            break;\n\n          case 'speech':\n            self.getComparison(\n              self.currentSentence,\n              message.capturedspeech,\n              function(comparison) {\n                self.gotComparison(comparison, message);\n              }\n            );\n            break;\n\n        }\n\n      });\n      self.mak = props.modelaudiokaraoke;\n\n      self.prepare_controls();\n      self.register_events();\n      self.register_mak();\n    },\n\n    activate: function() {\n      this.results = [];\n      this.activated = true;\n    },\n    deactivate: function() {\n      if (this.mak.controls.audioplayer[0].playing) {\n        this.mak.controls.audioplayer[0].pause();\n      }\n      this.activated = false;\n    },\n\n    prepare_controls: function() {\n      var self = this;\n      self.controls.container = $('#' + def.landrcontainer);\n      self.controls.hiddenplayer = $('#mod_readaloud_landr_hiddenplayer');\n      self.controls.playbutton = $('#mod_readaloud_landr_modalplay');\n      self.controls.skipbutton = $('#mod_readaloud_landr_modalskip');\n      self.controls.finishedbutton = $(\"#mod_readaloud_landr_modalfinished\");\n      self.audiourl = self.mak.fetch_audio_url();\n      self.controls.hiddenplayer.attr('src', self.audiourl);\n\n    },\n\n    register_mak: function() {\n      var self = this;\n\n      self.mak.on_reach_audio_break = function(sentence, oldbreak, newbreak, breaks) {\n        //do not get involved if we are not active\n        //model audio karaoke is used elsewhere (shadow and preview) as well\n        if (!self.activated) {\n          return;\n        }\n\n        // sentence contains the target text\n\n        //empty strings are none of our concern\n        if (sentence.trim() === '') {\n          return;\n        }\n\n        self.currentSentence = sentence;\n        self.currentAudioStart = oldbreak.audiotime;\n        self.currentAudioEnd = newbreak.audiotime;\n\n        log.debug(sentence);\n        log.debug(oldbreak);\n        log.debug(newbreak);\n\n        //pause audio while we do our thing\n        if (oldbreak.breaknumber == 0 && newbreak == false) {\n          // do nothing\n        } else {\n          // detect last line\n          if (newbreak.breaknumber == breaks[breaks.length - 1].breaknumber) {\n            self.controls.finishedbutton.show();\n            self.controls.skipbutton.hide();\n          } else {\n            self.controls.finishedbutton.hide();\n            self.controls.skipbutton.show();\n          }\n          self.mak.pause_audio();\n          self.controls.container.modal('show');\n          $(\"#mod_readaloud_modal_target_phrase\").html(sentence.split(/ /).map(function(e, i) {\n            return '<span class=\"mod_readaloud_modal_target_word\" data-index=\"' + i + '\">' + e + '</span>';\n          }));\n        }\n\n      }\n\n    },\n\n    register_events: function() {\n\n      var self = this;\n\n      self.controls.playbutton.on('click', function(e) {\n        self.controls.hiddenplayer[0].currentTime = self.currentAudioStart;\n        self.controls.hiddenplayer[0].play();\n      });\n\n      self.controls.skipbutton.on('click', function(e) {\n        self.controls.container.modal('hide');\n        if (self.controls.hiddenplayer[0].playing) {\n          self.controls.hiddenplayer[0].pause();\n        }\n        self.mak.play_audio();\n      });\n\n      self.controls.finishedbutton.on('click', function() {\n        self.controls.container.modal('hide');\n        self.mak.controls.audioplayer[0].currentTime = 0;\n      });\n\n      self.controls.hiddenplayer[0].ontimeupdate = function() {\n        if (self.controls.hiddenplayer[0].currentTime >= self.currentAudioEnd) {\n          self.controls.hiddenplayer[0].pause();\n        }\n      };\n\n    },\n\n    spliton: new RegExp('([,.!?:;\" ])', 'g'),\n\n    gotComparison: function(comparison, typed) {\n\n      var self = this;\n      var thisClass;\n      $(\".mod_readaloud_modal_target_word\").removeClass(\"mod_readaloud_modal_target_word_correct mod_readaloud_modal_target_word_incorrect\");\n      comparison.forEach(function(word, idx) {\n        thisClass = word.matched ? \"mod_readaloud_modal_target_word_correct\" : \"mod_readaloud_modal_target_word_incorrect\";\n        $(\".mod_readaloud_modal_target_word[data-index='\" + idx + \"']\").addClass(thisClass);\n      })\n\n    },\n    getComparison: function(passage, transcript, callback) {\n      var self = this;\n\n      ajax.call([{\n        methodname: 'mod_readaloud_compare_passage_to_transcript',\n        args: {\n          passage: passage,\n          transcript: transcript,\n          alternatives: '',\n          language: 'en-US'\n        },\n        done: function(ajaxresult) {\n          var payloadobject = JSON.parse(ajaxresult);\n          if (payloadobject) {\n            callback(payloadobject);\n          } else {\n            callback(false);\n          }\n        },\n        fail: function(err) {\n          console.log(err);\n        }\n      }]);\n\n    }\n\n  };\n});"],"file":"listenandrepeat.min.js"}