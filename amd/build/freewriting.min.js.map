{"version":3,"file":"freewriting.min.js","sources":["../src/freewriting.js"],"sourcesContent":["define(['jquery', 'core/log', 'mod_readaloud/definitions', 'mod_readaloud/correctionsmarkup', 'core/templates'],\r\n    function($, log, def,  correctionsmarkup, templates) {\r\n  \"use strict\"; // jshint ;_;\r\n\r\n  /*\r\n  This file is to manage the free writing item type\r\n   */\r\n\r\n  log.debug('Readaloud FreeWriting: initialising');\r\n\r\n      return {\r\n\r\n        transcript_evaluation: null,\r\n        rawscore: 0,\r\n        percentscore: 0,\r\n\r\n        //for making multiple instances\r\n        clone: function () {\r\n          return $.extend(true, {}, this);\r\n        },\r\n\r\n        init: function(index, itemdata, quizhelper) {\r\n          this.itemdata = itemdata;\r\n          this.quizhelper = quizhelper;\r\n          this.init_components(quizhelper,itemdata);\r\n          this.register_events(index, itemdata, quizhelper);\r\n        },\r\n\r\n        next_question: function() {\r\n          var self = this;\r\n          var stepdata = {};\r\n          stepdata.index = self.index;\r\n          stepdata.hasgrade = true;\r\n          stepdata.totalitems = self.itemdata.totalmarks;\r\n          stepdata.correctitems = self.rawscore > 0 ? self.rawscore : 0;\r\n          stepdata.grade = self.percentscore;\r\n          stepdata.resultsdata = self.transcript_evaluation;\r\n          self.quizhelper.do_next(stepdata);\r\n        },\r\n\r\n        calculate_score: function(transcript_evaluation) {\r\n          var self = this;\r\n\r\n          if(transcript_evaluation === null){\r\n            return 0;\r\n          }\r\n\r\n          //words ratio\r\n          var wordsratio = 1;\r\n          if(self.itemdata.countwords) {\r\n            wordsratio = transcript_evaluation.stats.words / self.itemdata.targetwordcount;\r\n            if(wordsratio > 1){wordsratio = 1;}\r\n          }\r\n\r\n          //relevance\r\n          var relevanceratio = 1;\r\n          if(self.itemdata.relevance > 0){\r\n            relevanceratio = (transcript_evaluation.stats.relevance + 10) / 100;\r\n            if(relevanceratio > 1){relevanceratio = 1;}\r\n          }\r\n          //calculate score based on AI grade * relevance * wordcount\r\n          var score = Math.round(transcript_evaluation.marks * relevanceratio * wordsratio);\r\n          return score;\r\n        },\r\n\r\n        register_events: function(index, itemdata, quizhelper) {\r\n          var self = this;\r\n          self.index = index;\r\n          self.quizhelper = quizhelper;\r\n\r\n          self.nextbutton.on('click', function(e) {\r\n            self.next_question();\r\n          });\r\n\r\n          self.thetextarea.on('input', function(e) {\r\n            e.preventDefault();\r\n            var wordcount = self.quizhelper.count_words(self.thetextarea.val());\r\n            self.wordcount.text(wordcount);\r\n          });\r\n\r\n          self.submitbutton.on('click', function(e) {\r\n            e.preventDefault();\r\n            var transcript = self.thetextarea.val();\r\n            //update the wordcount\r\n            var wordcount = self.quizhelper.count_words(transcript);\r\n            self.wordcount.text(wordcount);\r\n\r\n            self.do_evaluation(transcript);\r\n          });\r\n\r\n        },\r\n\r\n        init_components: function(quizhelper,itemdata){\r\n          var self=this;\r\n          self.allwords = $(\"#\" + self.itemdata.uniqueid + \"_container.mod_readaloud_mu_passage_word\");\r\n          self.submitbutton = $(\"#\" + itemdata.uniqueid + \"_container .ml_freewriting_submitbutton\");\r\n          self.nextbutton = $(\"#\" + itemdata.uniqueid + \"_container .readaloud_nextbutton\");\r\n          self.thetextarea = $(\"#\" + self.itemdata.uniqueid + \"_container .ml_freewriting_textarea\");\r\n          self.wordcount = $(\"#\" + self.itemdata.uniqueid + \"_container span.ml_wordcount\");\r\n          self.actionbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freewriting_actionbox\");\r\n          self.pendingbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freewriting_pendingbox\");\r\n          self.resultsbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freewriting_resultsbox\");\r\n          self.timerdisplay = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freewriting_timerdisplay\");\r\n        }, //end of init components\r\n\r\n        do_corrections_markup: function(grammarerrors,grammarmatches,insertioncount) {\r\n          var self = this;\r\n          //corrected text container is created at runtime, so it wont exist at init_components time\r\n          //thats we find it here\r\n          var correctionscontainer = self.resultsbox.find('.mlfsr_correctedtext');\r\n\r\n          correctionsmarkup.init({ \"correctionscontainer\": correctionscontainer,\r\n            \"grammarerrors\": grammarerrors,\r\n            \"grammarmatches\": grammarmatches,\r\n            \"insertioncount\": insertioncount});\r\n        },\r\n\r\n        do_evaluation: function(speechtext) {\r\n          var self = this;\r\n\r\n          //show a spinner while we do the AI stuff\r\n          self.resultsbox.hide();\r\n          self.actionbox.hide();\r\n          self.pendingbox.show();\r\n\r\n          //do evaluation\r\n          this.quizhelper.evaluateTranscript(speechtext,this.itemdata.itemid).then(function(ajaxresult) {\r\n            var transcript_evaluation = JSON.parse(ajaxresult);\r\n            if (transcript_evaluation) {\r\n              //calculate raw score and percent score\r\n              transcript_evaluation.rawscore = self.calculate_score(transcript_evaluation);\r\n              self.rawscore = self.calculate_score(transcript_evaluation);\r\n              if(self.itemdata.totalmarks > 0){\r\n                self.percentscore = Math.round((self.rawscore / self.itemdata.totalmarks) * 100);\r\n              }\r\n              //add raw and percent score to trancript_evaluation for mustache\r\n              transcript_evaluation.rawscore = self.rawscore;\r\n              transcript_evaluation.percentscore = self.percentscore;\r\n              transcript_evaluation.rawspeech = speechtext;\r\n              transcript_evaluation.maxscore = self.itemdata.totalmarks;\r\n              self.transcript_evaluation = transcript_evaluation;\r\n\r\n              log.debug(transcript_evaluation);\r\n              //display results\r\n              templates.render('mod_readaloud/freewritingresults',transcript_evaluation).then(\r\n                  function(html,js){\r\n                    self.resultsbox.html(html);\r\n                    //do corrections markup\r\n                    if(transcript_evaluation.hasOwnProperty('grammarerrors')){\r\n                      self.do_corrections_markup(transcript_evaluation.grammarerrors,\r\n                          transcript_evaluation.grammarmatches,\r\n                          transcript_evaluation.insertioncount\r\n                      );\r\n                    }\r\n                    //show and hide\r\n                    self.resultsbox.show();\r\n                    self.pendingbox.hide();\r\n                    self.actionbox.hide();\r\n                    templates.runTemplateJS(js);\r\n                    //reset timer and wordcount on this page, in case reattempt\r\n                    self.wordcount.text('0');\r\n                    self.ttrec.timer.reset();\r\n                    var displaytime = self.ttrec.timer.fetch_display_time();\r\n                    self.timerdisplay.html(displaytime);\r\n                  }\r\n              );// End of templates\r\n            } else {\r\n              log.debug('transcript_evaluation: oh no it failed');\r\n              self.resultsbox.hide();\r\n              self.pendingbox.hide();\r\n              self.actionbox.show();\r\n            }\r\n          });\r\n        },\r\n      };\r\n});"],"names":["define","$","log","def","correctionsmarkup","templates","debug","transcript_evaluation","rawscore","percentscore","clone","extend","this","init","index","itemdata","quizhelper","init_components","register_events","next_question","stepdata","hasgrade","totalitems","totalmarks","correctitems","grade","resultsdata","do_next","calculate_score","wordsratio","countwords","stats","words","targetwordcount","relevanceratio","relevance","Math","round","marks","self","nextbutton","on","e","thetextarea","preventDefault","wordcount","count_words","val","text","submitbutton","transcript","do_evaluation","allwords","uniqueid","actionbox","pendingbox","resultsbox","timerdisplay","do_corrections_markup","grammarerrors","grammarmatches","insertioncount","correctionscontainer","find","speechtext","hide","show","evaluateTranscript","itemid","then","ajaxresult","JSON","parse","rawspeech","maxscore","render","html","js","hasOwnProperty","runTemplateJS","ttrec","timer","reset","displaytime","fetch_display_time"],"mappings":"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"}